<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中文字符串提取和翻译工具 - Transtation</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #4facfe;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #4facfe;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .strings-container {
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 20px;
        }

        .string-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .string-item:hover {
            background-color: #f8f9fa;
        }

        .string-item:last-child {
            border-bottom: none;
        }

        .string-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .string-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .string-text {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
        }

        .string-file {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            max-width: 200px;
            overflow-x: auto;
            white-space: nowrap;
            font-family: 'Courier New', monospace;
        }
        
        .string-file::-webkit-scrollbar {
            height: 4px;
        }
        
        .string-file::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .string-file::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .string-file::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .string-context {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .string-translation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .translation-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .control-buttons {
            margin: 12px 0;
            padding: 12px 12px 0px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* 高级配置样式 */
        .advanced-config {
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .advanced-toggle {
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .advanced-toggle:hover {
            background: #e9ecef;
        }

        .advanced-content {
            padding: 20px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* 改进的字符串选择样式 */
        .string-item {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .string-item.selected {
            background-color: #e3f2fd !important;
            border-left: 4px solid #4facfe;
        }

        .string-item.drag-selecting {
            background-color: #bbdefb !important;
        }

        .string-item:hover {
            background-color: #f5f5f5;
        }

        .string-item.selected:hover {
            background-color: #e1f5fe !important;
        }

        .strings-container {
            user-select: none;
        }

        /* 拖拽选择提示 */
        .drag-select-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        /* 已翻译字符串展示区样式 */
        .translated-strings-container {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 500px;
            overflow-y: auto;
        }

        .translated-string-item {
            background: white;
            padding: 16px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .translated-string-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .translated-string-item:last-child {
            margin-bottom: 0;
        }

        .translated-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .original-text {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
            flex: 1;
            margin-right: 15px;
            line-height: 1.4;
        }

        .file-info {
            font-size: 12px;
            color: #6c757d;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            font-family: 'Courier New', monospace;
            max-width: 50vw;
            overflow-x: auto;
        }

        .translation-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 12px;
        }

        .translation-field {
            display: flex;
            flex-direction: column;
        }

        .field-label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .translation-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .translation-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            background: #fafbfc;
        }

        .translation-input:hover {
            border-color: #dee2e6;
        }

        .format-hint {
            font-size: 12px;
            color: #6c757d;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 空状态提示 */
        .empty-translated {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .translation-row {
                grid-template-columns: 1fr;
            }
            
            .translation-display {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .translated-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .original-text {
                margin-right: 0;
                margin-bottom: 8px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .advanced-content {
                padding: 15px 10px;
            }

            .translated-strings-container {
                padding: 15px;
            }

            .translated-string-item {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>🌐 Transtation 字符串国际化工具</h1>
            <p>自动提取、翻译和替换 Kotlin 项目中的中文字符串</p>
        </div>

        <div class="main-content">
            <!-- 步骤1: 配置项目 -->
            <div class="step" :class="{ active: currentStep === 1 }">
                <div class="step-title">
                    <span class="step-number">1</span>
                    项目配置
                </div>
                
                <div class="form-group">
                    <label for="projectPath">项目根目录路径：</label>
                    <input 
                        type="text" 
                        id="projectPath" 
                        v-model="config.projectPath" 
                        placeholder="例如: /path/to/your/kotlin/project"
                    >
                </div>

                <div class="form-group">
                    <label for="apiKey">OpenAI API Key：</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        v-model="config.apiKey" 
                        placeholder="sk-..."
                    >
                </div>

                <div class="form-group">
                    <label for="baseUrl">API Base URL（可选）：</label>
                    <input 
                        type="text" 
                        id="baseUrl" 
                        v-model="config.baseUrl" 
                        placeholder="例如: https://api.openai.com/v1"
                    >
                </div>

                <!-- 高级配置区域 -->
                <div class="advanced-config">
                    <div class="advanced-toggle" @click="showAdvanced = !showAdvanced">
                        <span>{{ showAdvanced ? '🔽' : '▶️' }} 高级配置</span>
                    </div>
                    
                    <div v-show="showAdvanced" class="advanced-content">
                        <div class="form-group">
                            <label for="modelName">模型名称：</label>
                            <input 
                                type="text" 
                                id="modelName" 
                                v-model="config.modelName" 
                                placeholder="例如: gpt-4o-mini"
                            > 
                            <small style="color: #666; margin-top: 5px; display: block;">
                                支持的模型名称：gpt-4o-mini, gpt-4o, gpt-4-turbo, gpt-3.5-turbo
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="batchSize">批次大小：</label>
                            <input 
                                type="number" 
                                id="batchSize" 
                                v-model.number="config.batchSize" 
                                min="1" 
                                max="100"
                                placeholder="每次翻译的字符串数量"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">建议设置为50以内，过大可能导致翻译质量下降</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="sourceXmlPath">源XML文件路径模板：</label>
                            <input 
                                type="text" 
                                id="sourceXmlPath" 
                                v-model="config.sourceXmlPath" 
                                placeholder="例如: {module_name}/src/commonMain/libres/strings/strings_zh.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                使用 {module_name} 作为占位符，系统会自动替换为实际的模块名
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetLanguage">目标语言代码：</label>
                            <input 
                                type="text" 
                                id="targetLanguage" 
                                v-model="config.targetLanguage" 
                                placeholder="例如: en"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                目标翻译语言的代码，如 en（英文）、ja（日文）、ko（韩文）等
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetXmlPath">目标XML文件路径模板：</label>
                            <input 
                                type="text" 
                                id="targetXmlPath" 
                                v-model="config.targetXmlPath" 
                                placeholder="例如: {module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                使用 {module_name} 和 {target_lang} 作为占位符
                            </small>
                        </div>

                         <div class="form-group">
                            <label for="customPrompt">翻译提示词：</label>
                            <textarea 
                                id="customPrompt" 
                                v-model="config.customPrompt" 
                                rows="6"
                                placeholder="在这里输入自定义的翻译提示，例如：请将以下文本翻译成符合软件界面习惯的英文..."
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="referenceTranslations">参考翻译（可选）：</label>
                            <div style="margin-bottom: 10px;">
                                <button 
                                    type="button" 
                                    class="btn btn-secondary" 
                                    @click="autoExtractReferences" 
                                    :disabled="loading || !config.projectPath.trim()"
                                    style="font-size: 12px; padding: 8px 12px;"
                                >
                                    <span v-if="extractingReferences">提取中...</span>
                                    <span v-else>🔄 自动提取参考翻译</span>
                                </button>
                                <small style="color: #666; margin-left: 10px;">
                                    从现有的XML文件中提取10条翻译对照
                                </small>
                            </div>
                            <textarea 
                                id="referenceTranslations" 
                                v-model="config.referenceTranslations" 
                                rows="8"
                                placeholder="输入已有的翻译键值对供AI参考，格式：&#10;登录 -> Login&#10;用户名 -> Username&#10;密码 -> Password&#10;确认 -> Confirm&#10;&#10;每行一个键值对，用 -> 分隔中文和英文"
                            ></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                提供现有翻译作为参考，帮助AI保持翻译风格的一致性
                            </small>
                        </div>
                    </div>
                </div>

                <button class="btn" @click="extractStrings" :disabled="loading">
                    <span v-if="loading">提取中...</span>
                    <span v-else>🔍 提取字符串</span>
                </button>
                
                <!-- 状态管理按钮 -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <small style="color: #666; display: block; margin-bottom: 10px;">状态管理：</small>
                    <button class="btn btn-secondary" @click="manualSave" :disabled="strings.length === 0">
                        💾 保存当前状态
                    </button>
                    <button class="btn btn-danger" @click="clearSavedState" style="background: #dc3545;">
                        🗑️ 清除保存的状态
                    </button>
                    <div v-if="ignoredStrings.size > 0" style="margin-top: 10px; padding: 8px 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;">
                        🚫 已忽略 {{ ignoredStrings.size }} 个字符串
                    </div>
                </div>
            </div>

            <!-- 错误信息 -->
            <div v-if="error" class="error">
                ❌ {{ error }}
            </div>

            <!-- 成功信息 -->
            <div v-if="successMessage" class="success">
                ✅ {{ successMessage }}
            </div>

            <!-- 步骤2: 选择字符串 -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 2 }">
                <div class="step-title">
                    <span class="step-number">2</span>
                    选择要翻译的字符串
                </div>

                <!-- 已翻译字符串独立展示区 -->
                <div v-if="translatedStrings.length > 0" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2em; display: flex; align-items: center;">
                        ✅ 已翻译字符串 ({{ translatedStrings.length }})
                    </h3>
                    
                    <div class="translated-strings-container">
                        <div v-for="str in translatedStrings" 
                             :key="str.unique_id" 
                             class="translated-string-item">
                            <div class="translated-header">
                                <div class="original-text">{{ str.text }}</div>
                                <div class="file-info">{{ str.file_path }}:{{ str.line_number }}</div>
                            </div>
                            
                            <div class="translation-display">
                                <div class="translation-field">
                                    <label class="field-label">资源名称</label>
                                    <input 
                                        type="text" 
                                        v-model="str.resource_name" 
                                        placeholder="例如: login_success"
                                        class="translation-input"
                                        @input="updateUniqueId(str)"
                                    >
                                </div>
                                <div class="translation-field">
                                    <label class="field-label">翻译结果</label>
                                    <input 
                                        type="text" 
                                        v-model="str.translation" 
                                        placeholder="英文翻译"
                                        class="translation-input"
                                    >
                                </div>
                            </div>
                            
                            <div v-if="str.is_format_string" class="format-hint">
                                📝 格式化字符串，参数: {{ str.format_params.join(', ') }}
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 20px; color: #333; font-size: 1.2em; display: flex; align-items: center;">
                    ● 待处理字符串 ({{ untranslatedStrings.length }}），已选择 {{ selectedCount }}
                </h3>

                 <!-- 控制按钮 -->
                 <div>
                    <button class="btn" @click="selectAll">📋 全选</button>
                    <button class="btn btn-secondary" @click="selectNone">❌ 取消全选</button>
                    <button class="btn btn-secondary" @click="ignoreSelected" :disabled="loading || selectedCount === 0">
                        🚫 忽略选中项 ({{ selectedCount }})
                    </button>
                    <button class="btn" @click="translateSelected" :disabled="loading || selectedCount === 0">
                        <span v-if="loading">翻译中...</span>
                        <span v-else>🌐 翻译选中项 ({{ selectedCount }})</span>
                    </button>
                </div>

                <!-- 字符串列表 -->
                <div class="strings-container" @mousedown="startSelection" @mouseup="endSelection" @mousemove="updateDragSelection">    
                    <div v-for="(str, index) in untranslatedStrings" 
                         :key="str.unique_id || `${str.file_path}:${str.line_number}`" 
                         class="string-item" 
                         :class="{ 'selected': str.selected, 'drag-selecting': isDragSelecting && dragSelectedItems.has(str.unique_id) }"
                         @click="toggleStringSelection(str, $event)"
                         @mouseenter="onItemMouseEnter(str, index)"
                         :data-index="index">
                        <div class="string-header">
                            <input 
                                type="checkbox" 
                                class="string-checkbox"
                                v-model="str.selected"
                                @change="updateSelection"
                                @click.stop
                            >
                            <div class="string-text">{{ str.text }}</div>
                            <div class="string-file" :title="str.file_path + ':' + str.line_number">{{ str.file_path }}:{{ str.line_number }}</div>
                        </div>

                        <div class="string-context">{{ str.context }}</div>

                        <!-- 格式化参数提示 -->
                        <div v-if="str.is_format_string" style="margin-top: 10px; font-size: 12px; color: #666;">
                            📝 格式化字符串，参数: {{ str.format_params.join(', ') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤3: 保存更改 -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 3 }">
                <div class="step-title">
                    <span class="step-number">3</span>
                    保存更改
                </div>

                <p style="margin-bottom: 20px; color: #666;">
                    确认翻译结果无误后，点击保存按钮将生成 strings.xml 文件并替换代码中的字符串。
                </p>

                <button class="btn" @click="saveChanges" :disabled="loading">
                    <span v-if="loading">保存中...</span>
                    <span v-else>💾 保存更改</span>
                </button>
            </div>

            <!-- 加载状态 -->
            <div v-if="loading && strings.length === 0" class="loading">
                <div class="spinner"></div>
                <div>正在处理中，请稍候...</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const DEFTAULT_PROMPT = `你是一个专业的软件国际化翻译专家。请将以下中文字符串翻译成{target_language}，并为每个字符串生成一个合适的资源名称。

要求：
1. 翻译要准确、自然，符合软件界面的语言习惯
2. 资源名称使用snake_case格式，简洁明了，能体现字符串的用途
3. 对于包含格式化参数（如\${{name}}）的字符串，保持参数不变。如："共有\${{count}}个模型" -> "\${{count}} models in total"
4. "译站"翻译为"Transtation" 
5. 返回JSON格式，包含name、translation字段

已有的翻译参考：
{reference_translations}

待翻译字符串：
{source_strings}

请返回JSON数组格式的结果。`

        createApp({
            data() {
                return {
                    currentStep: 1,
                    loading: false,
                    error: '',
                    successMessage: '',
                    showAdvanced: false,
                    config: {
                        projectPath: 'D:/projects/kotlin/Transtation',
                        apiKey: '',
                        baseUrl: '',
                        modelName: 'gpt-4o-mini',
                        batchSize: 50,
                        customPrompt: DEFTAULT_PROMPT,
                        referenceTranslations: '',
                        sourceXmlPath: '{module_name}/src/commonMain/libres/strings/strings_zh.xml',
                        targetLanguage: 'en',
                        targetXmlPath: '{module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml'
                    },
                    strings: [],
                    selectedCount: 0,
                    translatedCount: 0,
                    extractingReferences: false, // 自动提取参考翻译状态
                    // 拖拽选择相关
                    isDragSelecting: false,
                    dragStartIndex: -1,
                    dragSelectedItems: new Set(),
                    lastSelectedStates: new Map(), // 保存翻译前的选择状态
                    // 本地存储键名
                    STORAGE_KEYS: {
                        CONFIG: 'transtation_config',
                        STRINGS: 'transtation_strings',
                        SELECTION_STATE: 'transtation_selection',
                        IGNORED_STRINGS: 'transtation_ignored_strings'
                    },
                    ignoredStrings: new Set() // 被忽略的字符串集合
                }
            },
            computed: {
                // 筛选出已翻译的字符串（有翻译结果且有资源名称）
                translatedStrings() {
                    return this.strings.filter(str => 
                        str.resource_name && str.resource_name.trim() && 
                        str.translation && str.translation.trim()
                    );
                },
                // 未翻译的字符串（主列表显示的内容）
                untranslatedStrings() {
                    return this.strings.filter(str => 
                        !(str.resource_name && str.resource_name.trim() && 
                          str.translation && str.translation.trim())
                    );
                }
            },
            mounted() {
                // 页面加载时恢复状态
                this.loadIgnoredStrings(); // 先加载忽略字符串
                this.loadSavedState();
                // 监听页面卸载，保存状态
                window.addEventListener('beforeunload', () => {
                    this.saveCurrentState();
                });
                // 定期自动保存状态
                setInterval(() => {
                    if (this.strings.length > 0) {
                        this.saveCurrentState();
                    }
                }, 30000); // 每30秒保存一次
            },
            methods: {
                async extractStrings() {
                    if (!this.config.projectPath.trim()) {
                        this.error = '请输入项目路径';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/extract', {
                            project_path: this.config.projectPath
                        });

                        if (response.data.success) {
                            this.strings = response.data.strings
                                .filter(str => !this.ignoredStrings.has(str.text)) // 过滤掉已忽略的字符串
                                .map(str => {
                                    // 确保设置module_name
                                    if (!str.module_name) {
                                        str.module_name = this.extractModuleName(str.file_path);
                                    }
                                    return {
                                        ...str,
                                        selected: true,
                                        // 前端维护unique_id
                                        unique_id: this.generateUniqueId(str)
                                    };
                                });
                            this.currentStep = 2;
                            this.updateCounts();
                            this.successMessage = `成功提取 ${response.data.count} 个中文字符串`;
                        } else {
                            this.error = response.data.error || '提取失败';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || '网络错误';
                    } finally {
                        this.loading = false;
                    }
                },

                async translateSelected() {
                    if (!this.config.apiKey.trim()) {
                        this.error = '请输入 OpenAI API Key';
                        return;
                    }

                    const selectedIds = this.strings
                        .filter(str => str.selected)
                        .map(str => str.unique_id);

                    if (selectedIds.length === 0) {
                        this.error = '请至少选择一个字符串进行翻译';
                        return;
                    }

                    // 保存翻译前的选择状态
                    this.lastSelectedStates.clear();
                    this.strings.forEach(str => {
                        this.lastSelectedStates.set(str.unique_id, str.selected);
                    });

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/translate', {
                            api_key: this.config.apiKey,
                            base_url: this.config.baseUrl,
                            model_name: this.config.modelName,
                            batch_size: this.config.batchSize,
                            custom_prompt: this.config.customPrompt,
                            reference_translations: this.config.referenceTranslations,
                            selected_ids: selectedIds
                        });

                        if (response.data.success) {
                            // 更新字符串数据，但保持原有的选择状态
                            const updatedStrings = response.data.strings;
                            updatedStrings.forEach(updatedStr => {
                                // 确保设置module_name
                                if (!updatedStr.module_name) {
                                    updatedStr.module_name = this.extractModuleName(updatedStr.file_path);
                                }
                                // 前端维护unique_id
                                updatedStr.unique_id = this.generateUniqueId(updatedStr);
                                
                                const originalSelected = this.lastSelectedStates.get(updatedStr.unique_id);
                                if (originalSelected !== undefined) {
                                    updatedStr.selected = originalSelected;
                                }
                            });
                            
                            this.strings = updatedStrings;
                            this.currentStep = 3;
                            this.updateCounts();
                            this.successMessage = `成功翻译 ${response.data.results.length} 个字符串`;
                            
                            // 翻译完成后自动保存状态
                            this.saveCurrentState();
                        } else {
                            this.error = response.data.error || '翻译失败';
                            // 翻译失败时恢复选择状态
                            this.restoreSelectionStates();
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || '翻译请求失败';
                        // 翻译失败时恢复选择状态
                        this.restoreSelectionStates();
                    } finally {
                        this.loading = false;
                    }
                },

                async saveChanges() {
                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/save', {
                            strings: this.strings,
                            ignored_strings: []
                        });

                        if (response.data.success) {
                            this.successMessage = '保存成功！已生成 strings.xml 文件并替换代码中的字符串';
                        } else {
                            this.error = response.data.error || '保存失败';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || '保存请求失败';
                    } finally {
                        this.loading = false;
                    }
                },

                ignoreSelected() {
                    const selectedStrings = this.strings.filter(str => str.selected);

                    if (selectedStrings.length === 0) {
                        this.error = '请至少选择一个字符串进行忽略';
                        return;
                    }

                    // 将选中的字符串添加到忽略集合
                    selectedStrings.forEach(str => {
                        this.ignoredStrings.add(str.text);
                    });

                    // 从列表中移除忽略的字符串
                    this.strings = this.strings.filter(str => !str.selected);
                    this.updateCounts();
                    
                    // 保存忽略的字符串到localStorage
                    this.saveIgnoredStrings();
                    
                    this.successMessage = `已忽略 ${selectedStrings.length} 个字符串`;
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 3000);
                },

                selectAll() {
                    // 限制最大选择数量
                    let selectedCount = 0;
                    this.strings.forEach(str => {
                        if (selectedCount < this.config.batchSize) {
                            str.selected = true;
                            selectedCount++;
                        } else {
                            str.selected = false;
                        }
                    });
                    
                    if (this.strings.length > this.config.batchSize) {
                        this.successMessage = `已选择前 ${this.config.batchSize} 个条目（受批次大小限制）`;
                        setTimeout(() => {
                            this.successMessage = '';
                        }, 3000);
                    }
                    
                    this.updateSelection();
                },

                selectNone() {
                    this.strings.forEach(str => str.selected = false);
                    this.updateSelection();
                },

                updateSelection() {
                    this.updateCounts();
                },

                updateCounts() {
                    this.selectedCount = this.strings.filter(str => str.selected).length;
                    this.translatedCount = this.strings.filter(str => str.translation).length;
                },

                // 恢复选择状态
                restoreSelectionStates() {
                    this.strings.forEach(str => {
                        const originalSelected = this.lastSelectedStates.get(str.unique_id);
                        if (originalSelected !== undefined) {
                            str.selected = originalSelected;
                        }
                    });
                    this.updateCounts();
                },

                // 点击字符串条目切换选择状态
                toggleStringSelection(str, event) {
                    // 如果点击的是输入框等元素，不处理
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    // 检查是否会超出最大翻译条数限制
                    if (!str.selected && this.selectedCount >= this.config.batchSize) {
                        this.error = `单次最多只能选择 ${this.config.batchSize} 个条目进行翻译`;
                        setTimeout(() => {
                            this.error = '';
                        }, 3000);
                        return;
                    }
                    
                    // 默认是加选模式，不清除其他选择
                    str.selected = !str.selected;
                    
                    this.updateSelection();
                },

                // 拖拽选择开始
                startSelection(event) {
                    if (event.target.closest('.string-translation') || 
                        event.target.tagName === 'INPUT' || 
                        event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index) || !this.untranslatedStrings[index]) return;
                    
                    this.isDragSelecting = true;
                    this.dragStartIndex = index;
                    this.dragSelectedItems.clear();
                    
                    event.preventDefault();
                    
                    // 添加拖拽提示
                    this.showDragHint();
                },

                // 拖拽选择更新
                updateDragSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index)) return;
                    
                    // 计算选择范围
                    const start = Math.min(this.dragStartIndex, index);
                    const end = Math.max(this.dragStartIndex, index);
                    
                    this.dragSelectedItems.clear();
                    for (let i = start; i <= end; i++) {
                        if (this.untranslatedStrings[i]) {
                            this.dragSelectedItems.add(this.untranslatedStrings[i].unique_id);
                        }
                    }
                },

                // 拖拽选择结束
                endSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    // 应用拖拽选择的结果 - 反选经过的条目
                    this.strings.forEach(str => {
                        if (this.dragSelectedItems.has(str.unique_id)) {
                            str.selected = !str.selected;
                        }
                    });
                    
                    this.isDragSelecting = false;
                    this.dragStartIndex = -1;
                    this.dragSelectedItems.clear();
                    
                    this.updateSelection();
                    this.hideDragHint();
                },

                // 鼠标进入条目
                onItemMouseEnter(str, index) {
                    if (this.isDragSelecting) {
                        this.updateDragSelection({ target: { closest: () => ({ dataset: { index } }) } });
                    }
                },

                // 显示拖拽提示
                showDragHint() {
                    const hint = document.createElement('div');
                    hint.className = 'drag-select-hint';
                    hint.textContent = '拖拽反选多个条目';
                    hint.id = 'drag-hint';
                    document.body.appendChild(hint);
                },

                // 隐藏拖拽提示
                hideDragHint() {
                    const hint = document.getElementById('drag-hint');
                    if (hint) {
                        hint.remove();
                    }
                },

                // ==================== 本地状态管理 ====================

                // 保存当前状态到localStorage
                saveCurrentState() {
                    try {
                        // 保存配置
                        localStorage.setItem(this.STORAGE_KEYS.CONFIG, JSON.stringify(this.config));
                        
                        // 保存字符串数据（只保存必要的信息）
                        if (this.strings.length > 0) {
                            const stringsData = this.strings.map(str => ({
                                text: str.text,
                                file_path: str.file_path,
                                line_number: str.line_number,
                                context: str.context,
                                resource_name: str.resource_name || '',
                                translation: str.translation || '',
                                selected: str.selected,
                                is_format_string: str.is_format_string || false,
                                format_params: str.format_params || [],
                                module_name: str.module_name || this.extractModuleName(str.file_path),
                                // unique_id: str.unique_id || this.generateUniqueId(str)
                                // unique_id 来自 module_name 以及 text，故而无需保存
                            }));
                            
                            // 分批保存，避免localStorage容量限制
                            const batchSize = 50;
                            const totalBatches = Math.ceil(stringsData.length / batchSize);
                            
                            // 清除旧的批次数据
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            // 保存新的批次数据
                            for (let i = 0; i < totalBatches; i++) {
                                const start = i * batchSize;
                                const end = start + batchSize;
                                const batch = stringsData.slice(start, end);
                                localStorage.setItem(`${this.STORAGE_KEYS.STRINGS}_${i}`, JSON.stringify(batch));
                            }
                            
                            // 保存元数据
                            localStorage.setItem(this.STORAGE_KEYS.STRINGS + '_meta', JSON.stringify({
                                totalBatches: totalBatches,
                                totalCount: stringsData.length,
                                timestamp: Date.now(),
                                currentStep: this.currentStep
                            }));
                        }
                        
                        console.log('状态保存成功');
                    } catch (error) {
                        console.warn('保存状态失败:', error);
                    }
                },

                // 从localStorage加载保存的状态
                loadSavedState() {
                    try {
                        // 恢复配置
                        const savedConfig = localStorage.getItem(this.STORAGE_KEYS.CONFIG);
                        if (savedConfig) {
                            const config = JSON.parse(savedConfig);
                            // 保留敏感信息的初始值，只恢复非敏感配置
                            this.config = {
                                ...this.config,
                                projectPath: config.projectPath || this.config.projectPath,
                                baseUrl: config.baseUrl || this.config.baseUrl,
                                modelName: config.modelName || this.config.modelName,
                                batchSize: config.batchSize || this.config.batchSize,
                                customPrompt: config.customPrompt || this.config.customPrompt,
                                referenceTranslations: config.referenceTranslations || this.config.referenceTranslations,
                                apiKey: config.apiKey || this.config.apiKey,
                                sourceXmlPath: config.sourceXmlPath || this.config.sourceXmlPath,
                                targetLanguage: config.targetLanguage || this.config.targetLanguage,
                                targetXmlPath: config.targetXmlPath || this.config.targetXmlPath
                            };
                        }

                        // 恢复字符串数据
                        const metaData = localStorage.getItem(this.STORAGE_KEYS.STRINGS + '_meta');
                        if (metaData) {
                            const meta = JSON.parse(metaData);
                            const age = Date.now() - meta.timestamp;
                            
                            // 如果数据不超过10天，则恢复
                            if (age < 10 * 24 * 60 * 60 * 1000) {
                                let allStrings = [];
                                
                                // 加载所有批次
                                for (let i = 0; i < meta.totalBatches; i++) {
                                    const batchData = localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                                    if (batchData) {
                                        const batch = JSON.parse(batchData);
                                        allStrings = allStrings.concat(batch);
                                    }
                                }
                                
                                if (allStrings.length > 0) {
                                    // 确保每个字符串都有正确的unique_id和module_name，并过滤掉已忽略的字符串
                                    this.strings = allStrings
                                        .filter(str => !this.ignoredStrings.has(str.text)) // 过滤掉已忽略的字符串
                                        .map(str => {
                                            if (!str.module_name) {
                                                str.module_name = this.extractModuleName(str.file_path);
                                            }
                                            if (!str.unique_id) {
                                                str.unique_id = this.generateUniqueId(str);
                                            }
                                            return str;
                                        });

                                    axios.post('/api/update_current_strings', {
                                        "strings": allStrings
                                    }).then(response => {
                                        console.log("update_current_strings response: ", response.data)
                                    });

                                    this.currentStep = meta.currentStep || 2;
                                    this.updateCounts();
                                    
                                    this.successMessage = `已恢复 ${allStrings.length} 个字符串的状态`;
                                    setTimeout(() => {
                                        this.successMessage = '';
                                    }, 3000);
                                    
                                    console.log('字符串状态恢复成功:', allStrings.length);
                                }
                            } else {
                                console.log('保存的数据已过期，跳过恢复');
                                this.clearSavedState();
                            }
                        }
                    } catch (error) {
                        console.warn('加载状态失败:', error);
                    }
                },



                // 手动保存状态（供用户调用）
                manualSave() {
                    this.saveCurrentState();
                    this.successMessage = '状态保存成功！';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 2000);
                },

                // 清除保存的状态（带确认）
                clearSavedState() {
                    if (confirm('确定要清除所有保存的状态吗？这将删除配置、字符串数据、选择状态和忽略的字符串。')) {
                        try {
                            // 清除配置和字符串数据
                            localStorage.removeItem(this.STORAGE_KEYS.CONFIG);
                            localStorage.removeItem(this.STORAGE_KEYS.STRINGS + '_meta');
                            
                            // 清除所有批次数据
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            // 清除忽略的字符串
                            this.clearIgnoredStrings();
                            
                            this.successMessage = '状态清除完成！';
                            setTimeout(() => {
                                this.successMessage = '';
                            }, 2000);
                            
                            console.log('状态清除完成');
                        } catch (error) {
                            this.error = '清除状态失败: ' + error.message;
                            console.warn('清除状态失败:', error);
                        }
                    }
                },

                // ==================== 忽略字符串管理 ====================

                // 保存忽略的字符串到localStorage
                saveIgnoredStrings() {
                    try {
                        const ignoredArray = Array.from(this.ignoredStrings);
                        localStorage.setItem(this.STORAGE_KEYS.IGNORED_STRINGS, JSON.stringify(ignoredArray));
                        console.log('忽略字符串已保存:', ignoredArray.length);
                    } catch (error) {
                        console.warn('保存忽略字符串失败:', error);
                    }
                },

                // 从localStorage加载忽略的字符串
                loadIgnoredStrings() {
                    try {
                        const saved = localStorage.getItem(this.STORAGE_KEYS.IGNORED_STRINGS);
                        if (saved) {
                            const ignoredArray = JSON.parse(saved);
                            this.ignoredStrings = new Set(ignoredArray);
                            console.log('忽略字符串已加载:', ignoredArray.length);
                        }
                    } catch (error) {
                        console.warn('加载忽略字符串失败:', error);
                        this.ignoredStrings = new Set();
                    }
                },

                // 清除忽略字符串
                clearIgnoredStrings() {
                    this.ignoredStrings.clear();
                    localStorage.removeItem(this.STORAGE_KEYS.IGNORED_STRINGS);
                },

                // ==================== 辅助方法 ====================

                // 生成unique_id
                generateUniqueId(str) {
                    // 提取模块名
                    const moduleName = this.extractModuleName(str.file_path);
                    // 直接使用模块名和原始内容作为unique_id
                    return `${moduleName}:${str.text}`;
                },

                // 更新字符串的unique_id（现在unique_id基于模块名和原始内容，不会改变）
                updateUniqueId(str) {
                    // unique_id 现在基于模块名和原始内容，不会因为resource_name改变而改变
                    // 保留这个方法以防将来需要
                },

                // 从文件路径提取模块名
                extractModuleName(filePath) {
                    const parts = filePath.split('/');
                    return parts[0] || 'common';
                },

                // 自动提取参考翻译
                async autoExtractReferences() {
                    if (!this.config.projectPath.trim()) {
                        this.error = '请先设置项目路径';
                        return;
                    }

                    this.extractingReferences = true;
                    this.error = '';

                    try {
                        const response = await axios.post('/api/extract_references', {
                            project_path: this.config.projectPath,
                            source_xml_path: this.config.sourceXmlPath,
                            target_language: this.config.targetLanguage,
                            target_xml_path: this.config.targetXmlPath,
                            limit: 10
                        });

                        if (response.data.success) {
                            const references = response.data.references;
                            if (references && references.length > 0) {
                                // 将提取的翻译对照格式化为文本
                                const formattedReferences = references.map(ref => 
                                    `${ref.source} -> ${ref.target}`
                                ).join('\n');
                                
                                // 如果已有参考翻译，则追加，否则直接设置
                                if (this.config.referenceTranslations.trim()) {
                                    this.config.referenceTranslations += '\n' + formattedReferences;
                                } else {
                                    this.config.referenceTranslations = formattedReferences;
                                }
                                
                                this.successMessage = `成功提取了 ${references.length} 条参考翻译`;
                                setTimeout(() => {
                                    this.successMessage = '';
                                }, 3000);
                            } else {
                                this.error = '未找到可用的翻译对照，请检查XML文件路径配置';
                            }
                        } else {
                            this.error = response.data.error || '提取参考翻译失败';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || '提取参考翻译请求失败';
                    } finally {
                        this.extractingReferences = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>