<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡å­—ç¬¦ä¸²æå–å’Œç¿»è¯‘å·¥å…· - Transtation</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #4facfe;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #4facfe;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .strings-container {
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 20px;
        }

        .string-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .string-item:hover {
            background-color: #f8f9fa;
        }

        .string-item:last-child {
            border-bottom: none;
        }

        .string-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .string-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .string-text {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
        }

        .string-file {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .string-context {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .string-translation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .translation-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
            display: block;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .control-buttons {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* é«˜çº§é…ç½®æ ·å¼ */
        .advanced-config {
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .advanced-toggle {
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .advanced-toggle:hover {
            background: #e9ecef;
        }

        .advanced-content {
            padding: 20px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* æ”¹è¿›çš„å­—ç¬¦ä¸²é€‰æ‹©æ ·å¼ */
        .string-item {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .string-item.selected {
            background-color: #e3f2fd !important;
            border-left: 4px solid #4facfe;
        }

        .string-item.drag-selecting {
            background-color: #bbdefb !important;
        }

        .string-item:hover {
            background-color: #f5f5f5;
        }

        .string-item.selected:hover {
            background-color: #e1f5fe !important;
        }

        .strings-container {
            user-select: none;
        }

        /* æ‹–æ‹½é€‰æ‹©æç¤º */
        .drag-select-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .translation-row {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .advanced-content {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>ğŸŒ Transtation å­—ç¬¦ä¸²å›½é™…åŒ–å·¥å…·</h1>
            <p>è‡ªåŠ¨æå–ã€ç¿»è¯‘å’Œæ›¿æ¢ Kotlin é¡¹ç›®ä¸­çš„ä¸­æ–‡å­—ç¬¦ä¸²</p>
        </div>

        <div class="main-content">
            <!-- æ­¥éª¤1: é…ç½®é¡¹ç›® -->
            <div class="step" :class="{ active: currentStep === 1 }">
                <div class="step-title">
                    <span class="step-number">1</span>
                    é¡¹ç›®é…ç½®
                </div>
                
                <div class="form-group">
                    <label for="projectPath">é¡¹ç›®æ ¹ç›®å½•è·¯å¾„ï¼š</label>
                    <input 
                        type="text" 
                        id="projectPath" 
                        v-model="config.projectPath" 
                        placeholder="ä¾‹å¦‚: /path/to/your/kotlin/project"
                    >
                </div>

                <div class="form-group">
                    <label for="apiKey">OpenAI API Keyï¼š</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        v-model="config.apiKey" 
                        placeholder="sk-..."
                    >
                </div>

                <div class="form-group">
                    <label for="baseUrl">API Base URLï¼ˆå¯é€‰ï¼‰ï¼š</label>
                    <input 
                        type="text" 
                        id="baseUrl" 
                        v-model="config.baseUrl" 
                        placeholder="ä¾‹å¦‚: https://api.openai.com/v1"
                    >
                </div>

                <!-- é«˜çº§é…ç½®åŒºåŸŸ -->
                <div class="advanced-config">
                    <div class="advanced-toggle" @click="showAdvanced = !showAdvanced">
                        <span>{{ showAdvanced ? 'ğŸ”½' : 'â–¶ï¸' }} é«˜çº§é…ç½®</span>
                    </div>
                    
                    <div v-show="showAdvanced" class="advanced-content">
                        <div class="form-group">
                            <label for="modelName">æ¨¡å‹åç§°ï¼š</label>
                            <input 
                                type="text" 
                                id="modelName" 
                                v-model="config.modelName" 
                                placeholder="ä¾‹å¦‚: gpt-4o-mini"
                            > 
                            <small style="color: #666; margin-top: 5px; display: block;">
                                æ”¯æŒçš„æ¨¡å‹åç§°ï¼šgpt-4o-mini, gpt-4o, gpt-4-turbo, gpt-3.5-turbo
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="batchSize">æ‰¹æ¬¡å¤§å°ï¼š</label>
                            <input 
                                type="number" 
                                id="batchSize" 
                                v-model.number="config.batchSize" 
                                min="1" 
                                max="100"
                                placeholder="æ¯æ¬¡ç¿»è¯‘çš„å­—ç¬¦ä¸²æ•°é‡"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">å»ºè®®è®¾ç½®ä¸º50ä»¥å†…ï¼Œè¿‡å¤§å¯èƒ½å¯¼è‡´ç¿»è¯‘è´¨é‡ä¸‹é™</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="sourceXmlPath">æºXMLæ–‡ä»¶è·¯å¾„æ¨¡æ¿ï¼š</label>
                            <input 
                                type="text" 
                                id="sourceXmlPath" 
                                v-model="config.sourceXmlPath" 
                                placeholder="ä¾‹å¦‚: {module_name}/src/commonMain/libres/strings/strings_zh.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ä½¿ç”¨ {module_name} ä½œä¸ºå ä½ç¬¦ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…çš„æ¨¡å—å
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetLanguage">ç›®æ ‡è¯­è¨€ä»£ç ï¼š</label>
                            <input 
                                type="text" 
                                id="targetLanguage" 
                                v-model="config.targetLanguage" 
                                placeholder="ä¾‹å¦‚: en"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ç›®æ ‡ç¿»è¯‘è¯­è¨€çš„ä»£ç ï¼Œå¦‚ enï¼ˆè‹±æ–‡ï¼‰ã€jaï¼ˆæ—¥æ–‡ï¼‰ã€koï¼ˆéŸ©æ–‡ï¼‰ç­‰
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetXmlPath">ç›®æ ‡XMLæ–‡ä»¶è·¯å¾„æ¨¡æ¿ï¼š</label>
                            <input 
                                type="text" 
                                id="targetXmlPath" 
                                v-model="config.targetXmlPath" 
                                placeholder="ä¾‹å¦‚: {module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ä½¿ç”¨ {module_name} å’Œ {target_lang} ä½œä¸ºå ä½ç¬¦
                            </small>
                        </div>

                         <div class="form-group">
                            <label for="customPrompt">ç¿»è¯‘æç¤ºè¯ï¼š</label>
                            <textarea 
                                id="customPrompt" 
                                v-model="config.customPrompt" 
                                rows="6"
                                placeholder="åœ¨è¿™é‡Œè¾“å…¥è‡ªå®šä¹‰çš„ç¿»è¯‘æç¤ºï¼Œä¾‹å¦‚ï¼šè¯·å°†ä»¥ä¸‹æ–‡æœ¬ç¿»è¯‘æˆç¬¦åˆè½¯ä»¶ç•Œé¢ä¹ æƒ¯çš„è‹±æ–‡..."
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="referenceTranslations">å‚è€ƒç¿»è¯‘ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                            <div style="margin-bottom: 10px;">
                                <button 
                                    type="button" 
                                    class="btn btn-secondary" 
                                    @click="autoExtractReferences" 
                                    :disabled="loading || !config.projectPath.trim()"
                                    style="font-size: 12px; padding: 8px 12px;"
                                >
                                    <span v-if="extractingReferences">æå–ä¸­...</span>
                                    <span v-else>ğŸ”„ è‡ªåŠ¨æå–å‚è€ƒç¿»è¯‘</span>
                                </button>
                                <small style="color: #666; margin-left: 10px;">
                                    ä»ç°æœ‰çš„XMLæ–‡ä»¶ä¸­æå–10æ¡ç¿»è¯‘å¯¹ç…§
                                </small>
                            </div>
                            <textarea 
                                id="referenceTranslations" 
                                v-model="config.referenceTranslations" 
                                rows="8"
                                placeholder="è¾“å…¥å·²æœ‰çš„ç¿»è¯‘é”®å€¼å¯¹ä¾›AIå‚è€ƒï¼Œæ ¼å¼ï¼š&#10;ç™»å½• -> Login&#10;ç”¨æˆ·å -> Username&#10;å¯†ç  -> Password&#10;ç¡®è®¤ -> Confirm&#10;&#10;æ¯è¡Œä¸€ä¸ªé”®å€¼å¯¹ï¼Œç”¨ -> åˆ†éš”ä¸­æ–‡å’Œè‹±æ–‡"
                            ></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                æä¾›ç°æœ‰ç¿»è¯‘ä½œä¸ºå‚è€ƒï¼Œå¸®åŠ©AIä¿æŒç¿»è¯‘é£æ ¼çš„ä¸€è‡´æ€§
                            </small>
                        </div>
                    </div>
                </div>

                <button class="btn" @click="extractStrings" :disabled="loading">
                    <span v-if="loading">æå–ä¸­...</span>
                    <span v-else>ğŸ” æå–å­—ç¬¦ä¸²</span>
                </button>
                
                <!-- çŠ¶æ€ç®¡ç†æŒ‰é’® -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <small style="color: #666; display: block; margin-bottom: 10px;">çŠ¶æ€ç®¡ç†ï¼š</small>
                    <button class="btn btn-secondary" @click="manualSave" :disabled="strings.length === 0">
                        ğŸ’¾ ä¿å­˜å½“å‰çŠ¶æ€
                    </button>
                    <button class="btn btn-danger" @click="clearSavedState" style="background: #dc3545;">
                        ğŸ—‘ï¸ æ¸…é™¤ä¿å­˜çš„çŠ¶æ€
                    </button>
                </div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div v-if="error" class="error">
                âŒ {{ error }}
            </div>

            <!-- æˆåŠŸä¿¡æ¯ -->
            <div v-if="successMessage" class="success">
                âœ… {{ successMessage }}
            </div>

            <!-- æ­¥éª¤2: é€‰æ‹©å­—ç¬¦ä¸² -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 2 }">
                <div class="step-title">
                    <span class="step-number">2</span>
                    é€‰æ‹©è¦ç¿»è¯‘çš„å­—ç¬¦ä¸²
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats">
                    <div class="stat-card">
                        <span class="stat-number">{{ strings.length }}</span>
                        <div class="stat-label">æ€»è®¡å­—ç¬¦ä¸²</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">{{ selectedCount }}</span>
                        <div class="stat-label">å·²é€‰æ‹©</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">{{ translatedCount }}</span>
                        <div class="stat-label">å·²ç¿»è¯‘</div>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="control-buttons">
                    <button class="btn" @click="selectAll">ğŸ“‹ å…¨é€‰</button>
                    <button class="btn btn-secondary" @click="selectNone">âŒ å–æ¶ˆå…¨é€‰</button>
                    <button class="btn btn-secondary" @click="selectUntranslated">ğŸ”„ é€‰æ‹©æœªç¿»è¯‘</button>
                    <button class="btn" @click="translateSelected" :disabled="loading || selectedCount === 0">
                        <span v-if="loading">ç¿»è¯‘ä¸­...</span>
                        <span v-else>ğŸŒ ç¿»è¯‘é€‰ä¸­é¡¹ ({{ selectedCount }})</span>
                    </button>
                </div>

                <!-- å­—ç¬¦ä¸²åˆ—è¡¨ -->
                <div class="strings-container" @mousedown="startSelection" @mouseup="endSelection" @mousemove="updateDragSelection">
                    <div v-for="(str, index) in strings" 
                         :key="str.unique_id || `${str.file_path}:${str.line_number}`" 
                         class="string-item" 
                         :class="{ 'selected': str.selected, 'drag-selecting': isDragSelecting && dragSelectedItems.has(str.unique_id) }"
                         @click="toggleStringSelection(str, $event)"
                         @mouseenter="onItemMouseEnter(str, index)"
                         :data-index="index">
                        <div class="string-header">
                            <input 
                                type="checkbox" 
                                class="string-checkbox"
                                v-model="str.selected"
                                @change="updateSelection"
                                @click.stop
                            >
                            <div class="string-text">{{ str.text }}</div>
                            <div class="string-file">{{ str.file_path }}:{{ str.line_number }}</div>
                        </div>

                        <div class="string-context">{{ str.context }}</div>

                        <!-- ç¿»è¯‘ç»“æœ -->
                        <div v-if="str.resource_name || str.translation" class="string-translation">
                            <div class="translation-row">
                                <div>
                                    <label>èµ„æºåç§°ï¼š</label>
                                    <input 
                                        type="text" 
                                        v-model="str.resource_name" 
                                        placeholder="ä¾‹å¦‚: login_success"
                                        @input="updateUniqueId(str)"
                                        @click.stop
                                    >
                                </div>
                                <div>
                                    <label>è‹±æ–‡ç¿»è¯‘ï¼š</label>
                                    <input 
                                        type="text" 
                                        v-model="str.translation" 
                                        placeholder="è‹±æ–‡ç¿»è¯‘"
                                        @click.stop
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- æ ¼å¼åŒ–å‚æ•°æç¤º -->
                        <div v-if="str.is_format_string" style="margin-top: 10px; font-size: 12px; color: #666;">
                            ğŸ“ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå‚æ•°: {{ str.format_params.join(', ') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: ä¿å­˜æ›´æ”¹ -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 3 }">
                <div class="step-title">
                    <span class="step-number">3</span>
                    ä¿å­˜æ›´æ”¹
                </div>

                <p style="margin-bottom: 20px; color: #666;">
                    ç¡®è®¤ç¿»è¯‘ç»“æœæ— è¯¯åï¼Œç‚¹å‡»ä¿å­˜æŒ‰é’®å°†ç”Ÿæˆ strings.xml æ–‡ä»¶å¹¶æ›¿æ¢ä»£ç ä¸­çš„å­—ç¬¦ä¸²ã€‚
                </p>

                <button class="btn" @click="saveChanges" :disabled="loading">
                    <span v-if="loading">ä¿å­˜ä¸­...</span>
                    <span v-else>ğŸ’¾ ä¿å­˜æ›´æ”¹</span>
                </button>

                <button class="btn btn-secondary" @click="ignoreSelected" :disabled="loading || selectedCount === 0">
                    ğŸš« å¿½ç•¥é€‰ä¸­é¡¹ ({{ selectedCount }})
                </button>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="loading && strings.length === 0" class="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const DEFTAULT_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å›½é™…åŒ–ç¿»è¯‘ä¸“å®¶ã€‚è¯·å°†ä»¥ä¸‹ä¸­æ–‡å­—ç¬¦ä¸²ç¿»è¯‘æˆ{target_language}ï¼Œå¹¶ä¸ºæ¯ä¸ªå­—ç¬¦ä¸²ç”Ÿæˆä¸€ä¸ªåˆé€‚çš„èµ„æºåç§°ã€‚

è¦æ±‚ï¼š
1. ç¿»è¯‘è¦å‡†ç¡®ã€è‡ªç„¶ï¼Œç¬¦åˆè½¯ä»¶ç•Œé¢çš„è¯­è¨€ä¹ æƒ¯
2. èµ„æºåç§°ä½¿ç”¨snake_caseæ ¼å¼ï¼Œç®€æ´æ˜äº†ï¼Œèƒ½ä½“ç°å­—ç¬¦ä¸²çš„ç”¨é€”
3. å¯¹äºåŒ…å«æ ¼å¼åŒ–å‚æ•°ï¼ˆå¦‚\${{name}}ï¼‰çš„å­—ç¬¦ä¸²ï¼Œä¿æŒå‚æ•°ä¸å˜ã€‚å¦‚ï¼š"å…±æœ‰\${{count}}ä¸ªæ¨¡å‹" -> "\${{count}} models in total"
4. "è¯‘ç«™"ç¿»è¯‘ä¸º"Transtation" 
5. è¿”å›JSONæ ¼å¼ï¼ŒåŒ…å«nameã€translationå­—æ®µ

å·²æœ‰çš„ç¿»è¯‘å‚è€ƒï¼š
{reference_translations}

å¾…ç¿»è¯‘å­—ç¬¦ä¸²ï¼š
{source_strings}

è¯·è¿”å›JSONæ•°ç»„æ ¼å¼çš„ç»“æœã€‚`

        createApp({
            data() {
                return {
                    currentStep: 1,
                    loading: false,
                    error: '',
                    successMessage: '',
                    showAdvanced: false,
                    config: {
                        projectPath: 'D:/projects/kotlin/Transtation',
                        apiKey: '',
                        baseUrl: '',
                        modelName: 'gpt-4o-mini',
                        batchSize: 50,
                        customPrompt: DEFTAULT_PROMPT,
                        referenceTranslations: '',
                        sourceXmlPath: '{module_name}/src/commonMain/libres/strings/strings_zh.xml',
                        targetLanguage: 'en',
                        targetXmlPath: '{module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml'
                    },
                    strings: [],
                    selectedCount: 0,
                    translatedCount: 0,
                    extractingReferences: false, // è‡ªåŠ¨æå–å‚è€ƒç¿»è¯‘çŠ¶æ€
                    // æ‹–æ‹½é€‰æ‹©ç›¸å…³
                    isDragSelecting: false,
                    dragStartIndex: -1,
                    dragSelectedItems: new Set(),
                    lastSelectedStates: new Map(), // ä¿å­˜ç¿»è¯‘å‰çš„é€‰æ‹©çŠ¶æ€
                    // æœ¬åœ°å­˜å‚¨é”®å
                    STORAGE_KEYS: {
                        CONFIG: 'transtation_config',
                        STRINGS: 'transtation_strings',
                        SELECTION_STATE: 'transtation_selection'
                    }
                }
            },
            mounted() {
                // é¡µé¢åŠ è½½æ—¶æ¢å¤çŠ¶æ€
                this.loadSavedState();
                // ç›‘å¬é¡µé¢å¸è½½ï¼Œä¿å­˜çŠ¶æ€
                window.addEventListener('beforeunload', () => {
                    this.saveCurrentState();
                });
                // å®šæœŸè‡ªåŠ¨ä¿å­˜çŠ¶æ€
                setInterval(() => {
                    if (this.strings.length > 0) {
                        this.saveCurrentState();
                    }
                }, 30000); // æ¯30ç§’ä¿å­˜ä¸€æ¬¡
            },
            methods: {
                async extractStrings() {
                    if (!this.config.projectPath.trim()) {
                        this.error = 'è¯·è¾“å…¥é¡¹ç›®è·¯å¾„';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/extract', {
                            project_path: this.config.projectPath
                        });

                        if (response.data.success) {
                            this.strings = response.data.strings.map(str => ({
                                ...str,
                                selected: true,
                                // å‰ç«¯ç»´æŠ¤unique_id
                                unique_id: this.generateUniqueId(str)
                            }));
                            this.currentStep = 2;
                            this.updateCounts();
                            this.successMessage = `æˆåŠŸæå– ${response.data.count} ä¸ªä¸­æ–‡å­—ç¬¦ä¸²`;
                        } else {
                            this.error = response.data.error || 'æå–å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ç½‘ç»œé”™è¯¯';
                    } finally {
                        this.loading = false;
                    }
                },

                async translateSelected() {
                    if (!this.config.apiKey.trim()) {
                        this.error = 'è¯·è¾“å…¥ OpenAI API Key';
                        return;
                    }

                    const selectedIds = this.strings
                        .filter(str => str.selected)
                        .map(str => str.unique_id);

                    if (selectedIds.length === 0) {
                        this.error = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œç¿»è¯‘';
                        return;
                    }

                    // ä¿å­˜ç¿»è¯‘å‰çš„é€‰æ‹©çŠ¶æ€
                    this.lastSelectedStates.clear();
                    this.strings.forEach(str => {
                        this.lastSelectedStates.set(str.unique_id, str.selected);
                    });

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/translate', {
                            api_key: this.config.apiKey,
                            base_url: this.config.baseUrl,
                            model_name: this.config.modelName,
                            batch_size: this.config.batchSize,
                            custom_prompt: this.config.customPrompt,
                            reference_translations: this.config.referenceTranslations,
                            selected_ids: selectedIds
                        });

                        if (response.data.success) {
                            // æ›´æ–°å­—ç¬¦ä¸²æ•°æ®ï¼Œä½†ä¿æŒåŸæœ‰çš„é€‰æ‹©çŠ¶æ€
                            const updatedStrings = response.data.strings;
                            updatedStrings.forEach(updatedStr => {
                                // å‰ç«¯ç»´æŠ¤unique_id
                                updatedStr.unique_id = this.generateUniqueId(updatedStr);
                                
                                const originalSelected = this.lastSelectedStates.get(updatedStr.unique_id);
                                if (originalSelected !== undefined) {
                                    updatedStr.selected = originalSelected;
                                }
                            });
                            
                            this.strings = updatedStrings;
                            this.currentStep = 3;
                            this.updateCounts();
                            this.successMessage = `æˆåŠŸç¿»è¯‘ ${response.data.results.length} ä¸ªå­—ç¬¦ä¸²`;
                        } else {
                            this.error = response.data.error || 'ç¿»è¯‘å¤±è´¥';
                            // ç¿»è¯‘å¤±è´¥æ—¶æ¢å¤é€‰æ‹©çŠ¶æ€
                            this.restoreSelectionStates();
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ç¿»è¯‘è¯·æ±‚å¤±è´¥';
                        // ç¿»è¯‘å¤±è´¥æ—¶æ¢å¤é€‰æ‹©çŠ¶æ€
                        this.restoreSelectionStates();
                    } finally {
                        this.loading = false;
                    }
                },

                async saveChanges() {
                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/save', {
                            strings: this.strings,
                            ignored_strings: []
                        });

                        if (response.data.success) {
                            this.successMessage = 'ä¿å­˜æˆåŠŸï¼å·²ç”Ÿæˆ strings.xml æ–‡ä»¶å¹¶æ›¿æ¢ä»£ç ä¸­çš„å­—ç¬¦ä¸²';
                        } else {
                            this.error = response.data.error || 'ä¿å­˜å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ä¿å­˜è¯·æ±‚å¤±è´¥';
                    } finally {
                        this.loading = false;
                    }
                },

                async ignoreSelected() {
                    const selectedTexts = this.strings
                        .filter(str => str.selected)
                        .map(str => str.text);

                    if (selectedTexts.length === 0) {
                        this.error = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œå¿½ç•¥';
                        return;
                    }

                    this.loading = true;
                    this.error = '';

                    try {
                        const response = await axios.post('/api/save', {
                            strings: [],
                            ignored_strings: selectedTexts
                        });

                        if (response.data.success) {
                            // ä»åˆ—è¡¨ä¸­ç§»é™¤å¿½ç•¥çš„å­—ç¬¦ä¸²
                            this.strings = this.strings.filter(str => !str.selected);
                            this.updateCounts();
                            this.successMessage = `å·²å¿½ç•¥ ${selectedTexts.length} ä¸ªå­—ç¬¦ä¸²`;
                        } else {
                            this.error = response.data.error || 'å¿½ç•¥å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'å¿½ç•¥è¯·æ±‚å¤±è´¥';
                    } finally {
                        this.loading = false;
                    }
                },

                selectAll() {
                    this.strings.forEach(str => str.selected = true);
                    this.updateSelection();
                },

                selectNone() {
                    this.strings.forEach(str => str.selected = false);
                    this.updateSelection();
                },

                selectUntranslated() {
                    this.strings.forEach(str => {
                        str.selected = !str.translation;
                    });
                    this.updateSelection();
                },

                updateSelection() {
                    this.updateCounts();
                },

                updateCounts() {
                    this.selectedCount = this.strings.filter(str => str.selected).length;
                    this.translatedCount = this.strings.filter(str => str.translation).length;
                },

                // æ¢å¤é€‰æ‹©çŠ¶æ€
                restoreSelectionStates() {
                    this.strings.forEach(str => {
                        const originalSelected = this.lastSelectedStates.get(str.unique_id);
                        if (originalSelected !== undefined) {
                            str.selected = originalSelected;
                        }
                    });
                    this.updateCounts();
                },

                // ç‚¹å‡»å­—ç¬¦ä¸²æ¡ç›®åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                toggleStringSelection(str, event) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†ç­‰å…ƒç´ ï¼Œä¸å¤„ç†
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    // æ”¯æŒCtrl/Cmdå¤šé€‰
                    if (event.ctrlKey || event.metaKey) {
                        str.selected = !str.selected;
                    } else {
                        // å•é€‰æ¨¡å¼ï¼šåªé€‰ä¸­å½“å‰é¡¹ï¼Œå–æ¶ˆå…¶ä»–é¡¹
                        const wasSelected = str.selected;
                        this.strings.forEach(s => s.selected = false);
                        str.selected = !wasSelected;
                    }
                    
                    this.updateSelection();
                },

                // æ‹–æ‹½é€‰æ‹©å¼€å§‹
                startSelection(event) {
                    if (event.target.closest('.string-translation') || 
                        event.target.tagName === 'INPUT' || 
                        event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index)) return;
                    
                    this.isDragSelecting = true;
                    this.dragStartIndex = index;
                    this.dragSelectedItems.clear();
                    
                    event.preventDefault();
                    
                    // æ·»åŠ æ‹–æ‹½æç¤º
                    this.showDragHint();
                },

                // æ‹–æ‹½é€‰æ‹©æ›´æ–°
                updateDragSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index)) return;
                    
                    // è®¡ç®—é€‰æ‹©èŒƒå›´
                    const start = Math.min(this.dragStartIndex, index);
                    const end = Math.max(this.dragStartIndex, index);
                    
                    this.dragSelectedItems.clear();
                    for (let i = start; i <= end; i++) {
                        if (this.strings[i]) {
                            this.dragSelectedItems.add(this.strings[i].unique_id);
                        }
                    }
                },

                // æ‹–æ‹½é€‰æ‹©ç»“æŸ
                endSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    // åº”ç”¨æ‹–æ‹½é€‰æ‹©çš„ç»“æœ
                    this.strings.forEach(str => {
                        if (this.dragSelectedItems.has(str.unique_id)) {
                            str.selected = true;
                        }
                    });
                    
                    this.isDragSelecting = false;
                    this.dragStartIndex = -1;
                    this.dragSelectedItems.clear();
                    
                    this.updateSelection();
                    this.hideDragHint();
                },

                // é¼ æ ‡è¿›å…¥æ¡ç›®
                onItemMouseEnter(str, index) {
                    if (this.isDragSelecting) {
                        this.updateDragSelection({ target: { closest: () => ({ dataset: { index } }) } });
                    }
                },

                // æ˜¾ç¤ºæ‹–æ‹½æç¤º
                showDragHint() {
                    const hint = document.createElement('div');
                    hint.className = 'drag-select-hint';
                    hint.textContent = 'æ‹–æ‹½é€‰æ‹©å¤šä¸ªæ¡ç›®';
                    hint.id = 'drag-hint';
                    document.body.appendChild(hint);
                },

                // éšè—æ‹–æ‹½æç¤º
                hideDragHint() {
                    const hint = document.getElementById('drag-hint');
                    if (hint) {
                        hint.remove();
                    }
                },

                // ==================== æœ¬åœ°çŠ¶æ€ç®¡ç† ====================

                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°localStorage
                saveCurrentState() {
                    try {
                        // ä¿å­˜é…ç½®
                        localStorage.setItem(this.STORAGE_KEYS.CONFIG, JSON.stringify(this.config));
                        
                        // ä¿å­˜å­—ç¬¦ä¸²æ•°æ®ï¼ˆåªä¿å­˜å¿…è¦çš„ä¿¡æ¯ï¼‰
                        if (this.strings.length > 0) {
                            const stringsData = this.strings.map(str => ({
                                text: str.text,
                                file_path: str.file_path,
                                line_number: str.line_number,
                                context: str.context,
                                resource_name: str.resource_name || '',
                                translation: str.translation || '',
                                selected: str.selected,
                                is_format_string: str.is_format_string || false,
                                format_params: str.format_params || [],
                                module_name: str.module_name || '',
                                unique_id: str.unique_id || `${str.file_path}:${str.line_number}`
                            }));
                            
                            // åˆ†æ‰¹ä¿å­˜ï¼Œé¿å…localStorageå®¹é‡é™åˆ¶
                            const batchSize = 50;
                            const totalBatches = Math.ceil(stringsData.length / batchSize);
                            
                            // æ¸…é™¤æ—§çš„æ‰¹æ¬¡æ•°æ®
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            // ä¿å­˜æ–°çš„æ‰¹æ¬¡æ•°æ®
                            for (let i = 0; i < totalBatches; i++) {
                                const start = i * batchSize;
                                const end = start + batchSize;
                                const batch = stringsData.slice(start, end);
                                localStorage.setItem(`${this.STORAGE_KEYS.STRINGS}_${i}`, JSON.stringify(batch));
                            }
                            
                            // ä¿å­˜å…ƒæ•°æ®
                            localStorage.setItem(this.STORAGE_KEYS.STRINGS + '_meta', JSON.stringify({
                                totalBatches: totalBatches,
                                totalCount: stringsData.length,
                                timestamp: Date.now(),
                                currentStep: this.currentStep
                            }));
                        }
                        
                        console.log('çŠ¶æ€ä¿å­˜æˆåŠŸ');
                    } catch (error) {
                        console.warn('ä¿å­˜çŠ¶æ€å¤±è´¥:', error);
                    }
                },

                // ä»localStorageåŠ è½½ä¿å­˜çš„çŠ¶æ€
                loadSavedState() {
                    try {
                        // æ¢å¤é…ç½®
                        const savedConfig = localStorage.getItem(this.STORAGE_KEYS.CONFIG);
                        if (savedConfig) {
                            const config = JSON.parse(savedConfig);
                            // ä¿ç•™æ•æ„Ÿä¿¡æ¯çš„åˆå§‹å€¼ï¼Œåªæ¢å¤éæ•æ„Ÿé…ç½®
                            this.config = {
                                ...this.config,
                                projectPath: config.projectPath || this.config.projectPath,
                                baseUrl: config.baseUrl || this.config.baseUrl,
                                modelName: config.modelName || this.config.modelName,
                                batchSize: config.batchSize || this.config.batchSize,
                                customPrompt: config.customPrompt || this.config.customPrompt,
                                referenceTranslations: config.referenceTranslations || this.config.referenceTranslations,
                                apiKey: config.apiKey || this.config.apiKey,
                                sourceXmlPath: config.sourceXmlPath || this.config.sourceXmlPath,
                                targetLanguage: config.targetLanguage || this.config.targetLanguage,
                                targetXmlPath: config.targetXmlPath || this.config.targetXmlPath
                            };
                        }

                        // æ¢å¤å­—ç¬¦ä¸²æ•°æ®
                        const metaData = localStorage.getItem(this.STORAGE_KEYS.STRINGS + '_meta');
                        if (metaData) {
                            const meta = JSON.parse(metaData);
                            const age = Date.now() - meta.timestamp;
                            
                            // å¦‚æœæ•°æ®ä¸è¶…è¿‡10å¤©ï¼Œåˆ™æ¢å¤
                            if (age < 10 * 24 * 60 * 60 * 1000) {
                                let allStrings = [];
                                
                                // åŠ è½½æ‰€æœ‰æ‰¹æ¬¡
                                for (let i = 0; i < meta.totalBatches; i++) {
                                    const batchData = localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                                    if (batchData) {
                                        const batch = JSON.parse(batchData);
                                        allStrings = allStrings.concat(batch);
                                    }
                                }
                                
                                if (allStrings.length > 0) {
                                    this.strings = allStrings;

                                    axios.post('/api/update_current_strings', {
                                        "strings": allStrings
                                    }).then(response => {
                                        console.log("update_current_strings response: ", response.data)
                                    });

                                    this.currentStep = meta.currentStep || 2;
                                    this.updateCounts();
                                    
                                    this.successMessage = `å·²æ¢å¤ ${allStrings.length} ä¸ªå­—ç¬¦ä¸²çš„çŠ¶æ€`;
                                    setTimeout(() => {
                                        this.successMessage = '';
                                    }, 3000);
                                    
                                    console.log('å­—ç¬¦ä¸²çŠ¶æ€æ¢å¤æˆåŠŸ:', allStrings.length);
                                }
                            } else {
                                console.log('ä¿å­˜çš„æ•°æ®å·²è¿‡æœŸï¼Œè·³è¿‡æ¢å¤');
                                this.clearSavedState();
                            }
                        }
                    } catch (error) {
                        console.warn('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
                    }
                },



                // æ‰‹åŠ¨ä¿å­˜çŠ¶æ€ï¼ˆä¾›ç”¨æˆ·è°ƒç”¨ï¼‰
                manualSave() {
                    this.saveCurrentState();
                    this.successMessage = 'çŠ¶æ€ä¿å­˜æˆåŠŸï¼';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 2000);
                },

                // æ¸…é™¤ä¿å­˜çš„çŠ¶æ€ï¼ˆå¸¦ç¡®è®¤ï¼‰
                clearSavedState() {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„çŠ¶æ€å—ï¼Ÿè¿™å°†åˆ é™¤é…ç½®ã€å­—ç¬¦ä¸²æ•°æ®å’Œé€‰æ‹©çŠ¶æ€ã€‚')) {
                        try {
                            // æ¸…é™¤é…ç½®å’Œå­—ç¬¦ä¸²æ•°æ®
                            localStorage.removeItem(this.STORAGE_KEYS.CONFIG);
                            localStorage.removeItem(this.STORAGE_KEYS.STRINGS + '_meta');
                            
                            // æ¸…é™¤æ‰€æœ‰æ‰¹æ¬¡æ•°æ®
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            this.successMessage = 'çŠ¶æ€æ¸…é™¤å®Œæˆï¼';
                            setTimeout(() => {
                                this.successMessage = '';
                            }, 2000);
                            
                            console.log('çŠ¶æ€æ¸…é™¤å®Œæˆ');
                        } catch (error) {
                            this.error = 'æ¸…é™¤çŠ¶æ€å¤±è´¥: ' + error.message;
                            console.warn('æ¸…é™¤çŠ¶æ€å¤±è´¥:', error);
                        }
                    }
                },

                // ==================== è¾…åŠ©æ–¹æ³• ====================

                // ç”Ÿæˆunique_id
                generateUniqueId(str) {
                    if (str.resource_name && str.module_name) {
                        return `${str.module_name}:${str.resource_name}`;
                    }
                    // å¦‚æœæ²¡æœ‰resource_nameï¼Œä½¿ç”¨æ–‡ä»¶è·¯å¾„å’Œè¡Œå·
                    return `${str.file_path}:${str.line_number}`;
                },

                // æ›´æ–°å­—ç¬¦ä¸²çš„unique_id
                updateUniqueId(str) {
                    const oldId = str.unique_id;
                    const newId = this.generateUniqueId(str);
                    
                    if (oldId !== newId) {
                        str.unique_id = newId;
                        
                        // æ›´æ–°ç›¸å…³çš„çŠ¶æ€æ˜ å°„
                        if (this.lastSelectedStates.has(oldId)) {
                            const selected = this.lastSelectedStates.get(oldId);
                            this.lastSelectedStates.delete(oldId);
                            this.lastSelectedStates.set(newId, selected);
                        }
                    }
                },

                // ä»æ–‡ä»¶è·¯å¾„æå–æ¨¡å—å
                extractModuleName(filePath) {
                    const parts = filePath.split('/');
                    return parts[0] || 'common';
                },

                // è‡ªåŠ¨æå–å‚è€ƒç¿»è¯‘
                async autoExtractReferences() {
                    if (!this.config.projectPath.trim()) {
                        this.error = 'è¯·å…ˆè®¾ç½®é¡¹ç›®è·¯å¾„';
                        return;
                    }

                    this.extractingReferences = true;
                    this.error = '';

                    try {
                        const response = await axios.post('/api/extract_references', {
                            project_path: this.config.projectPath,
                            source_xml_path: this.config.sourceXmlPath,
                            target_language: this.config.targetLanguage,
                            target_xml_path: this.config.targetXmlPath,
                            limit: 10
                        });

                        if (response.data.success) {
                            const references = response.data.references;
                            if (references && references.length > 0) {
                                // å°†æå–çš„ç¿»è¯‘å¯¹ç…§æ ¼å¼åŒ–ä¸ºæ–‡æœ¬
                                const formattedReferences = references.map(ref => 
                                    `${ref.source} -> ${ref.target}`
                                ).join('\n');
                                
                                // å¦‚æœå·²æœ‰å‚è€ƒç¿»è¯‘ï¼Œåˆ™è¿½åŠ ï¼Œå¦åˆ™ç›´æ¥è®¾ç½®
                                if (this.config.referenceTranslations.trim()) {
                                    this.config.referenceTranslations += '\n' + formattedReferences;
                                } else {
                                    this.config.referenceTranslations = formattedReferences;
                                }
                                
                                this.successMessage = `æˆåŠŸæå–äº† ${references.length} æ¡å‚è€ƒç¿»è¯‘`;
                                setTimeout(() => {
                                    this.successMessage = '';
                                }, 3000);
                            } else {
                                this.error = 'æœªæ‰¾åˆ°å¯ç”¨çš„ç¿»è¯‘å¯¹ç…§ï¼Œè¯·æ£€æŸ¥XMLæ–‡ä»¶è·¯å¾„é…ç½®';
                            }
                        } else {
                            this.error = response.data.error || 'æå–å‚è€ƒç¿»è¯‘å¤±è´¥';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'æå–å‚è€ƒç¿»è¯‘è¯·æ±‚å¤±è´¥';
                    } finally {
                        this.extractingReferences = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>