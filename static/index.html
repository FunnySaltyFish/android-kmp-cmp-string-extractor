<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰∏≠ÊñáÂ≠óÁ¨¶‰∏≤ÊèêÂèñÂíåÁøªËØëÂ∑•ÂÖ∑ - Transtation</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .step {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #4facfe;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.2);
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #4facfe;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .strings-container {
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-top: 20px;
        }

        .string-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .string-item:hover {
            background-color: #f8f9fa;
        }

        .string-item:last-child {
            border-bottom: none;
        }

        .string-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .string-checkbox {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .string-text {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
        }

        .string-file {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .string-context {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .string-translation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .translation-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
            display: block;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .control-buttons {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        /* È´òÁ∫ßÈÖçÁΩÆÊ†∑Âºè */
        .advanced-config {
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .advanced-toggle {
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            font-weight: 500;
        }

        .advanced-toggle:hover {
            background: #e9ecef;
        }

        .advanced-content {
            padding: 20px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* ÊîπËøõÁöÑÂ≠óÁ¨¶‰∏≤ÈÄâÊã©Ê†∑Âºè */
        .string-item {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .string-item.selected {
            background-color: #e3f2fd !important;
            border-left: 4px solid #4facfe;
        }

        .string-item.drag-selecting {
            background-color: #bbdefb !important;
        }

        .string-item:hover {
            background-color: #f5f5f5;
        }

        .string-item.selected:hover {
            background-color: #e1f5fe !important;
        }

        .strings-container {
            user-select: none;
        }

        /* ÊãñÊãΩÈÄâÊã©ÊèêÁ§∫ */
        .drag-select-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .translation-row {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .advanced-content {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>üåê Transtation Â≠óÁ¨¶‰∏≤ÂõΩÈôÖÂåñÂ∑•ÂÖ∑</h1>
            <p>Ëá™Âä®ÊèêÂèñ„ÄÅÁøªËØëÂíåÊõøÊç¢ Kotlin È°πÁõÆ‰∏≠ÁöÑ‰∏≠ÊñáÂ≠óÁ¨¶‰∏≤</p>
        </div>

        <div class="main-content">
            <!-- Ê≠•È™§1: ÈÖçÁΩÆÈ°πÁõÆ -->
            <div class="step" :class="{ active: currentStep === 1 }">
                <div class="step-title">
                    <span class="step-number">1</span>
                    È°πÁõÆÈÖçÁΩÆ
                </div>
                
                <div class="form-group">
                    <label for="projectPath">È°πÁõÆÊ†πÁõÆÂΩïË∑ØÂæÑÔºö</label>
                    <input 
                        type="text" 
                        id="projectPath" 
                        v-model="config.projectPath" 
                        placeholder="‰æãÂ¶Ç: /path/to/your/kotlin/project"
                    >
                </div>

                <div class="form-group">
                    <label for="apiKey">OpenAI API KeyÔºö</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        v-model="config.apiKey" 
                        placeholder="sk-..."
                    >
                </div>

                <div class="form-group">
                    <label for="baseUrl">API Base URLÔºàÂèØÈÄâÔºâÔºö</label>
                    <input 
                        type="text" 
                        id="baseUrl" 
                        v-model="config.baseUrl" 
                        placeholder="‰æãÂ¶Ç: https://api.openai.com/v1"
                    >
                </div>

                <!-- È´òÁ∫ßÈÖçÁΩÆÂå∫Âüü -->
                <div class="advanced-config">
                    <div class="advanced-toggle" @click="showAdvanced = !showAdvanced">
                        <span>{{ showAdvanced ? 'üîΩ' : '‚ñ∂Ô∏è' }} È´òÁ∫ßÈÖçÁΩÆ</span>
                    </div>
                    
                    <div v-show="showAdvanced" class="advanced-content">
                        <div class="form-group">
                            <label for="modelName">Ê®°ÂûãÂêçÁß∞Ôºö</label>
                            <input 
                                type="text" 
                                id="modelName" 
                                v-model="config.modelName" 
                                placeholder="‰æãÂ¶Ç: gpt-4o-mini"
                            > 
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ÊîØÊåÅÁöÑÊ®°ÂûãÂêçÁß∞Ôºögpt-4o-mini, gpt-4o, gpt-4-turbo, gpt-3.5-turbo
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="batchSize">ÊâπÊ¨°Â§ßÂ∞èÔºö</label>
                            <input 
                                type="number" 
                                id="batchSize" 
                                v-model.number="config.batchSize" 
                                min="1" 
                                max="100"
                                placeholder="ÊØèÊ¨°ÁøªËØëÁöÑÂ≠óÁ¨¶‰∏≤Êï∞Èáè"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">Âª∫ËÆÆËÆæÁΩÆ‰∏∫50‰ª•ÂÜÖÔºåËøáÂ§ßÂèØËÉΩÂØºËá¥ÁøªËØëË¥®Èáè‰∏ãÈôç</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="sourceXmlPath">Ê∫êXMLÊñá‰ª∂Ë∑ØÂæÑÊ®°ÊùøÔºö</label>
                            <input 
                                type="text" 
                                id="sourceXmlPath" 
                                v-model="config.sourceXmlPath" 
                                placeholder="‰æãÂ¶Ç: {module_name}/src/commonMain/libres/strings/strings_zh.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ‰ΩøÁî® {module_name} ‰Ωú‰∏∫Âç†‰ΩçÁ¨¶ÔºåÁ≥ªÁªü‰ºöËá™Âä®ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑÊ®°ÂùóÂêç
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetLanguage">ÁõÆÊ†áËØ≠Ë®Ä‰ª£Á†ÅÔºö</label>
                            <input 
                                type="text" 
                                id="targetLanguage" 
                                v-model="config.targetLanguage" 
                                placeholder="‰æãÂ¶Ç: en"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ÁõÆÊ†áÁøªËØëËØ≠Ë®ÄÁöÑ‰ª£Á†ÅÔºåÂ¶Ç enÔºàËã±ÊñáÔºâ„ÄÅjaÔºàÊó•ÊñáÔºâ„ÄÅkoÔºàÈü©ÊñáÔºâÁ≠â
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="targetXmlPath">ÁõÆÊ†áXMLÊñá‰ª∂Ë∑ØÂæÑÊ®°ÊùøÔºö</label>
                            <input 
                                type="text" 
                                id="targetXmlPath" 
                                v-model="config.targetXmlPath" 
                                placeholder="‰æãÂ¶Ç: {module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml"
                            >
                            <small style="color: #666; margin-top: 5px; display: block;">
                                ‰ΩøÁî® {module_name} Âíå {target_lang} ‰Ωú‰∏∫Âç†‰ΩçÁ¨¶
                            </small>
                        </div>

                         <div class="form-group">
                            <label for="customPrompt">ÁøªËØëÊèêÁ§∫ËØçÔºö</label>
                            <textarea 
                                id="customPrompt" 
                                v-model="config.customPrompt" 
                                rows="6"
                                placeholder="Âú®ËøôÈáåËæìÂÖ•Ëá™ÂÆö‰πâÁöÑÁøªËØëÊèêÁ§∫Ôºå‰æãÂ¶ÇÔºöËØ∑Â∞Ü‰ª•‰∏ãÊñáÊú¨ÁøªËØëÊàêÁ¨¶ÂêàËΩØ‰ª∂ÁïåÈù¢‰π†ÊÉØÁöÑËã±Êñá..."
                            ></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="referenceTranslations">ÂèÇËÄÉÁøªËØëÔºàÂèØÈÄâÔºâÔºö</label>
                            <div style="margin-bottom: 10px;">
                                <button 
                                    type="button" 
                                    class="btn btn-secondary" 
                                    @click="autoExtractReferences" 
                                    :disabled="loading || !config.projectPath.trim()"
                                    style="font-size: 12px; padding: 8px 12px;"
                                >
                                    <span v-if="extractingReferences">ÊèêÂèñ‰∏≠...</span>
                                    <span v-else>üîÑ Ëá™Âä®ÊèêÂèñÂèÇËÄÉÁøªËØë</span>
                                </button>
                                <small style="color: #666; margin-left: 10px;">
                                    ‰ªéÁé∞ÊúâÁöÑXMLÊñá‰ª∂‰∏≠ÊèêÂèñ10Êù°ÁøªËØëÂØπÁÖß
                                </small>
                            </div>
                            <textarea 
                                id="referenceTranslations" 
                                v-model="config.referenceTranslations" 
                                rows="8"
                                placeholder="ËæìÂÖ•Â∑≤ÊúâÁöÑÁøªËØëÈîÆÂÄºÂØπ‰æõAIÂèÇËÄÉÔºåÊ†ºÂºèÔºö&#10;ÁôªÂΩï -> Login&#10;Áî®Êà∑Âêç -> Username&#10;ÂØÜÁ†Å -> Password&#10;Á°ÆËÆ§ -> Confirm&#10;&#10;ÊØèË°å‰∏Ä‰∏™ÈîÆÂÄºÂØπÔºåÁî® -> ÂàÜÈöî‰∏≠ÊñáÂíåËã±Êñá"
                            ></textarea>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Êèê‰æõÁé∞ÊúâÁøªËØë‰Ωú‰∏∫ÂèÇËÄÉÔºåÂ∏ÆÂä©AI‰øùÊåÅÁøªËØëÈ£éÊ†ºÁöÑ‰∏ÄËá¥ÊÄß
                            </small>
                        </div>
                    </div>
                </div>

                <button class="btn" @click="extractStrings" :disabled="loading">
                    <span v-if="loading">ÊèêÂèñ‰∏≠...</span>
                    <span v-else>üîç ÊèêÂèñÂ≠óÁ¨¶‰∏≤</span>
                </button>
                
                <!-- Áä∂ÊÄÅÁÆ°ÁêÜÊåâÈíÆ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                    <small style="color: #666; display: block; margin-bottom: 10px;">Áä∂ÊÄÅÁÆ°ÁêÜÔºö</small>
                    <button class="btn btn-secondary" @click="manualSave" :disabled="strings.length === 0">
                        üíæ ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
                    </button>
                    <button class="btn btn-danger" @click="clearSavedState" style="background: #dc3545;">
                        üóëÔ∏è Ê∏ÖÈô§‰øùÂ≠òÁöÑÁä∂ÊÄÅ
                    </button>
                </div>
            </div>

            <!-- ÈîôËØØ‰ø°ÊÅØ -->
            <div v-if="error" class="error">
                ‚ùå {{ error }}
            </div>

            <!-- ÊàêÂäü‰ø°ÊÅØ -->
            <div v-if="successMessage" class="success">
                ‚úÖ {{ successMessage }}
            </div>

            <!-- Ê≠•È™§2: ÈÄâÊã©Â≠óÁ¨¶‰∏≤ -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 2 }">
                <div class="step-title">
                    <span class="step-number">2</span>
                    ÈÄâÊã©Ë¶ÅÁøªËØëÁöÑÂ≠óÁ¨¶‰∏≤
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats">
                    <div class="stat-card">
                        <span class="stat-number">{{ strings.length }}</span>
                        <div class="stat-label">ÊÄªËÆ°Â≠óÁ¨¶‰∏≤</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">{{ selectedCount }}</span>
                        <div class="stat-label">Â∑≤ÈÄâÊã©</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">{{ translatedCount }}</span>
                        <div class="stat-label">Â∑≤ÁøªËØë</div>
                    </div>
                </div>

                <!-- ÊéßÂà∂ÊåâÈíÆ -->
                <div class="control-buttons">
                    <button class="btn" @click="selectAll">üìã ÂÖ®ÈÄâ</button>
                    <button class="btn btn-secondary" @click="selectNone">‚ùå ÂèñÊ∂àÂÖ®ÈÄâ</button>
                    <button class="btn btn-secondary" @click="selectUntranslated">üîÑ ÈÄâÊã©Êú™ÁøªËØë</button>
                    <button class="btn" @click="translateSelected" :disabled="loading || selectedCount === 0">
                        <span v-if="loading">ÁøªËØë‰∏≠...</span>
                        <span v-else>üåê ÁøªËØëÈÄâ‰∏≠È°π ({{ selectedCount }})</span>
                    </button>
                </div>

                <!-- Â≠óÁ¨¶‰∏≤ÂàóË°® -->
                <div class="strings-container" @mousedown="startSelection" @mouseup="endSelection" @mousemove="updateDragSelection">
                    <div v-for="(str, index) in strings" 
                         :key="str.unique_id || `${str.file_path}:${str.line_number}`" 
                         class="string-item" 
                         :class="{ 'selected': str.selected, 'drag-selecting': isDragSelecting && dragSelectedItems.has(str.unique_id) }"
                         @click="toggleStringSelection(str, $event)"
                         @mouseenter="onItemMouseEnter(str, index)"
                         :data-index="index">
                        <div class="string-header">
                            <input 
                                type="checkbox" 
                                class="string-checkbox"
                                v-model="str.selected"
                                @change="updateSelection"
                                @click.stop
                            >
                            <div class="string-text">{{ str.text }}</div>
                            <div class="string-file">{{ str.file_path }}:{{ str.line_number }}</div>
                        </div>

                        <div class="string-context">{{ str.context }}</div>

                        <!-- ÁøªËØëÁªìÊûú -->
                        <div v-if="str.resource_name || str.translation" class="string-translation">
                            <div class="translation-row">
                                <div>
                                    <label>ËµÑÊ∫êÂêçÁß∞Ôºö</label>
                                    <input 
                                        type="text" 
                                        v-model="str.resource_name" 
                                        placeholder="‰æãÂ¶Ç: login_success"
                                        @input="updateUniqueId(str)"
                                        @click.stop
                                    >
                                </div>
                                <div>
                                    <label>Ëã±ÊñáÁøªËØëÔºö</label>
                                    <input 
                                        type="text" 
                                        v-model="str.translation" 
                                        placeholder="Ëã±ÊñáÁøªËØë"
                                        @click.stop
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Ê†ºÂºèÂåñÂèÇÊï∞ÊèêÁ§∫ -->
                        <div v-if="str.is_format_string" style="margin-top: 10px; font-size: 12px; color: #666;">
                            üìù Ê†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÔºåÂèÇÊï∞: {{ str.format_params.join(', ') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ê≠•È™§3: ‰øùÂ≠òÊõ¥Êîπ -->
            <div v-if="strings.length > 0" class="step" :class="{ active: currentStep === 3 }">
                <div class="step-title">
                    <span class="step-number">3</span>
                    ‰øùÂ≠òÊõ¥Êîπ
                </div>

                <p style="margin-bottom: 20px; color: #666;">
                    Á°ÆËÆ§ÁøªËØëÁªìÊûúÊó†ËØØÂêéÔºåÁÇπÂáª‰øùÂ≠òÊåâÈíÆÂ∞ÜÁîüÊàê strings.xml Êñá‰ª∂Âπ∂ÊõøÊç¢‰ª£Á†Å‰∏≠ÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
                </p>

                <button class="btn" @click="saveChanges" :disabled="loading">
                    <span v-if="loading">‰øùÂ≠ò‰∏≠...</span>
                    <span v-else>üíæ ‰øùÂ≠òÊõ¥Êîπ</span>
                </button>

                <button class="btn btn-secondary" @click="ignoreSelected" :disabled="loading || selectedCount === 0">
                    üö´ ÂøΩÁï•ÈÄâ‰∏≠È°π ({{ selectedCount }})
                </button>
            </div>

            <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
            <div v-if="loading && strings.length === 0" class="loading">
                <div class="spinner"></div>
                <div>Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...</div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        const DEFTAULT_PROMPT = `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑËΩØ‰ª∂ÂõΩÈôÖÂåñÁøªËØë‰∏ìÂÆ∂„ÄÇËØ∑Â∞Ü‰ª•‰∏ã‰∏≠ÊñáÂ≠óÁ¨¶‰∏≤ÁøªËØëÊàê{target_language}ÔºåÂπ∂‰∏∫ÊØè‰∏™Â≠óÁ¨¶‰∏≤ÁîüÊàê‰∏Ä‰∏™ÂêàÈÄÇÁöÑËµÑÊ∫êÂêçÁß∞„ÄÇ

Ë¶ÅÊ±ÇÔºö
1. ÁøªËØëË¶ÅÂáÜÁ°Æ„ÄÅËá™ÁÑ∂ÔºåÁ¨¶ÂêàËΩØ‰ª∂ÁïåÈù¢ÁöÑËØ≠Ë®Ä‰π†ÊÉØ
2. ËµÑÊ∫êÂêçÁß∞‰ΩøÁî®snake_caseÊ†ºÂºèÔºåÁÆÄÊ¥ÅÊòé‰∫ÜÔºåËÉΩ‰ΩìÁé∞Â≠óÁ¨¶‰∏≤ÁöÑÁî®ÈÄî
3. ÂØπ‰∫éÂåÖÂê´Ê†ºÂºèÂåñÂèÇÊï∞ÔºàÂ¶Ç\${{name}}ÔºâÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰øùÊåÅÂèÇÊï∞‰∏çÂèò„ÄÇÂ¶ÇÔºö"ÂÖ±Êúâ\${{count}}‰∏™Ê®°Âûã" -> "\${{count}} models in total"
4. "ËØëÁ´ô"ÁøªËØë‰∏∫"Transtation" 
5. ËøîÂõûJSONÊ†ºÂºèÔºåÂåÖÂê´name„ÄÅtranslationÂ≠óÊÆµ

Â∑≤ÊúâÁöÑÁøªËØëÂèÇËÄÉÔºö
{reference_translations}

ÂæÖÁøªËØëÂ≠óÁ¨¶‰∏≤Ôºö
{source_strings}

ËØ∑ËøîÂõûJSONÊï∞ÁªÑÊ†ºÂºèÁöÑÁªìÊûú„ÄÇ`

        createApp({
            data() {
                return {
                    currentStep: 1,
                    loading: false,
                    error: '',
                    successMessage: '',
                    showAdvanced: false,
                    config: {
                        projectPath: 'D:/projects/kotlin/Transtation',
                        apiKey: '',
                        baseUrl: '',
                        modelName: 'gpt-4o-mini',
                        batchSize: 50,
                        customPrompt: DEFTAULT_PROMPT,
                        referenceTranslations: '',
                        sourceXmlPath: '{module_name}/src/commonMain/libres/strings/strings_zh.xml',
                        targetLanguage: 'en',
                        targetXmlPath: '{module_name}/src/commonMain/libres/strings/strings_{target_lang}.xml'
                    },
                    strings: [],
                    selectedCount: 0,
                    translatedCount: 0,
                    extractingReferences: false, // Ëá™Âä®ÊèêÂèñÂèÇËÄÉÁøªËØëÁä∂ÊÄÅ
                    // ÊãñÊãΩÈÄâÊã©Áõ∏ÂÖ≥
                    isDragSelecting: false,
                    dragStartIndex: -1,
                    dragSelectedItems: new Set(),
                    lastSelectedStates: new Map(), // ‰øùÂ≠òÁøªËØëÂâçÁöÑÈÄâÊã©Áä∂ÊÄÅ
                    // Êú¨Âú∞Â≠òÂÇ®ÈîÆÂêç
                    STORAGE_KEYS: {
                        CONFIG: 'transtation_config',
                        STRINGS: 'transtation_strings',
                        SELECTION_STATE: 'transtation_selection'
                    }
                }
            },
            mounted() {
                // È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÁä∂ÊÄÅ
                this.loadSavedState();
                // ÁõëÂê¨È°µÈù¢Âç∏ËΩΩÔºå‰øùÂ≠òÁä∂ÊÄÅ
                window.addEventListener('beforeunload', () => {
                    this.saveCurrentState();
                });
                // ÂÆöÊúüËá™Âä®‰øùÂ≠òÁä∂ÊÄÅ
                setInterval(() => {
                    if (this.strings.length > 0) {
                        this.saveCurrentState();
                    }
                }, 30000); // ÊØè30Áßí‰øùÂ≠ò‰∏ÄÊ¨°
            },
            methods: {
                async extractStrings() {
                    if (!this.config.projectPath.trim()) {
                        this.error = 'ËØ∑ËæìÂÖ•È°πÁõÆË∑ØÂæÑ';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/extract', {
                            project_path: this.config.projectPath
                        });

                        if (response.data.success) {
                            this.strings = response.data.strings.map(str => ({
                                ...str,
                                selected: true,
                                // ÂâçÁ´ØÁª¥Êä§unique_id
                                unique_id: this.generateUniqueId(str)
                            }));
                            this.currentStep = 2;
                            this.updateCounts();
                            this.successMessage = `ÊàêÂäüÊèêÂèñ ${response.data.count} ‰∏™‰∏≠ÊñáÂ≠óÁ¨¶‰∏≤`;
                        } else {
                            this.error = response.data.error || 'ÊèêÂèñÂ§±Ë¥•';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ÁΩëÁªúÈîôËØØ';
                    } finally {
                        this.loading = false;
                    }
                },

                async translateSelected() {
                    if (!this.config.apiKey.trim()) {
                        this.error = 'ËØ∑ËæìÂÖ• OpenAI API Key';
                        return;
                    }

                    const selectedIds = this.strings
                        .filter(str => str.selected)
                        .map(str => str.unique_id);

                    if (selectedIds.length === 0) {
                        this.error = 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ËøõË°åÁøªËØë';
                        return;
                    }

                    // ‰øùÂ≠òÁøªËØëÂâçÁöÑÈÄâÊã©Áä∂ÊÄÅ
                    this.lastSelectedStates.clear();
                    this.strings.forEach(str => {
                        this.lastSelectedStates.set(str.unique_id, str.selected);
                    });

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/translate', {
                            api_key: this.config.apiKey,
                            base_url: this.config.baseUrl,
                            model_name: this.config.modelName,
                            batch_size: this.config.batchSize,
                            custom_prompt: this.config.customPrompt,
                            reference_translations: this.config.referenceTranslations,
                            selected_ids: selectedIds
                        });

                        if (response.data.success) {
                            // Êõ¥Êñ∞Â≠óÁ¨¶‰∏≤Êï∞ÊçÆÔºå‰ΩÜ‰øùÊåÅÂéüÊúâÁöÑÈÄâÊã©Áä∂ÊÄÅ
                            const updatedStrings = response.data.strings;
                            updatedStrings.forEach(updatedStr => {
                                // ÂâçÁ´ØÁª¥Êä§unique_id
                                updatedStr.unique_id = this.generateUniqueId(updatedStr);
                                
                                const originalSelected = this.lastSelectedStates.get(updatedStr.unique_id);
                                if (originalSelected !== undefined) {
                                    updatedStr.selected = originalSelected;
                                }
                            });
                            
                            this.strings = updatedStrings;
                            this.currentStep = 3;
                            this.updateCounts();
                            this.successMessage = `ÊàêÂäüÁøªËØë ${response.data.results.length} ‰∏™Â≠óÁ¨¶‰∏≤`;
                        } else {
                            this.error = response.data.error || 'ÁøªËØëÂ§±Ë¥•';
                            // ÁøªËØëÂ§±Ë¥•Êó∂ÊÅ¢Â§çÈÄâÊã©Áä∂ÊÄÅ
                            this.restoreSelectionStates();
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ÁøªËØëËØ∑Ê±ÇÂ§±Ë¥•';
                        // ÁøªËØëÂ§±Ë¥•Êó∂ÊÅ¢Â§çÈÄâÊã©Áä∂ÊÄÅ
                        this.restoreSelectionStates();
                    } finally {
                        this.loading = false;
                    }
                },

                async saveChanges() {
                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';

                    try {
                        const response = await axios.post('/api/save', {
                            strings: this.strings,
                            ignored_strings: []
                        });

                        if (response.data.success) {
                            this.successMessage = '‰øùÂ≠òÊàêÂäüÔºÅÂ∑≤ÁîüÊàê strings.xml Êñá‰ª∂Âπ∂ÊõøÊç¢‰ª£Á†Å‰∏≠ÁöÑÂ≠óÁ¨¶‰∏≤';
                        } else {
                            this.error = response.data.error || '‰øùÂ≠òÂ§±Ë¥•';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || '‰øùÂ≠òËØ∑Ê±ÇÂ§±Ë¥•';
                    } finally {
                        this.loading = false;
                    }
                },

                async ignoreSelected() {
                    const selectedTexts = this.strings
                        .filter(str => str.selected)
                        .map(str => str.text);

                    if (selectedTexts.length === 0) {
                        this.error = 'ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ËøõË°åÂøΩÁï•';
                        return;
                    }

                    this.loading = true;
                    this.error = '';

                    try {
                        const response = await axios.post('/api/save', {
                            strings: [],
                            ignored_strings: selectedTexts
                        });

                        if (response.data.success) {
                            // ‰ªéÂàóË°®‰∏≠ÁßªÈô§ÂøΩÁï•ÁöÑÂ≠óÁ¨¶‰∏≤
                            this.strings = this.strings.filter(str => !str.selected);
                            this.updateCounts();
                            this.successMessage = `Â∑≤ÂøΩÁï• ${selectedTexts.length} ‰∏™Â≠óÁ¨¶‰∏≤`;
                        } else {
                            this.error = response.data.error || 'ÂøΩÁï•Â§±Ë¥•';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ÂøΩÁï•ËØ∑Ê±ÇÂ§±Ë¥•';
                    } finally {
                        this.loading = false;
                    }
                },

                selectAll() {
                    this.strings.forEach(str => str.selected = true);
                    this.updateSelection();
                },

                selectNone() {
                    this.strings.forEach(str => str.selected = false);
                    this.updateSelection();
                },

                selectUntranslated() {
                    this.strings.forEach(str => {
                        str.selected = !str.translation;
                    });
                    this.updateSelection();
                },

                updateSelection() {
                    this.updateCounts();
                },

                updateCounts() {
                    this.selectedCount = this.strings.filter(str => str.selected).length;
                    this.translatedCount = this.strings.filter(str => str.translation).length;
                },

                // ÊÅ¢Â§çÈÄâÊã©Áä∂ÊÄÅ
                restoreSelectionStates() {
                    this.strings.forEach(str => {
                        const originalSelected = this.lastSelectedStates.get(str.unique_id);
                        if (originalSelected !== undefined) {
                            str.selected = originalSelected;
                        }
                    });
                    this.updateCounts();
                },

                // ÁÇπÂáªÂ≠óÁ¨¶‰∏≤Êù°ÁõÆÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                toggleStringSelection(str, event) {
                    // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØËæìÂÖ•Ê°ÜÁ≠âÂÖÉÁ¥†Ôºå‰∏çÂ§ÑÁêÜ
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    // ÊîØÊåÅCtrl/CmdÂ§öÈÄâ
                    if (event.ctrlKey || event.metaKey) {
                        str.selected = !str.selected;
                    } else {
                        // ÂçïÈÄâÊ®°ÂºèÔºöÂè™ÈÄâ‰∏≠ÂΩìÂâçÈ°πÔºåÂèñÊ∂àÂÖ∂‰ªñÈ°π
                        const wasSelected = str.selected;
                        this.strings.forEach(s => s.selected = false);
                        str.selected = !wasSelected;
                    }
                    
                    this.updateSelection();
                },

                // ÊãñÊãΩÈÄâÊã©ÂºÄÂßã
                startSelection(event) {
                    if (event.target.closest('.string-translation') || 
                        event.target.tagName === 'INPUT' || 
                        event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index)) return;
                    
                    this.isDragSelecting = true;
                    this.dragStartIndex = index;
                    this.dragSelectedItems.clear();
                    
                    event.preventDefault();
                    
                    // Ê∑ªÂä†ÊãñÊãΩÊèêÁ§∫
                    this.showDragHint();
                },

                // ÊãñÊãΩÈÄâÊã©Êõ¥Êñ∞
                updateDragSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    const stringItem = event.target.closest('.string-item');
                    if (!stringItem) return;
                    
                    const index = parseInt(stringItem.dataset.index);
                    if (isNaN(index)) return;
                    
                    // ËÆ°ÁÆóÈÄâÊã©ËåÉÂõ¥
                    const start = Math.min(this.dragStartIndex, index);
                    const end = Math.max(this.dragStartIndex, index);
                    
                    this.dragSelectedItems.clear();
                    for (let i = start; i <= end; i++) {
                        if (this.strings[i]) {
                            this.dragSelectedItems.add(this.strings[i].unique_id);
                        }
                    }
                },

                // ÊãñÊãΩÈÄâÊã©ÁªìÊùü
                endSelection(event) {
                    if (!this.isDragSelecting) return;
                    
                    // Â∫îÁî®ÊãñÊãΩÈÄâÊã©ÁöÑÁªìÊûú
                    this.strings.forEach(str => {
                        if (this.dragSelectedItems.has(str.unique_id)) {
                            str.selected = true;
                        }
                    });
                    
                    this.isDragSelecting = false;
                    this.dragStartIndex = -1;
                    this.dragSelectedItems.clear();
                    
                    this.updateSelection();
                    this.hideDragHint();
                },

                // Èº†Ê†áËøõÂÖ•Êù°ÁõÆ
                onItemMouseEnter(str, index) {
                    if (this.isDragSelecting) {
                        this.updateDragSelection({ target: { closest: () => ({ dataset: { index } }) } });
                    }
                },

                // ÊòæÁ§∫ÊãñÊãΩÊèêÁ§∫
                showDragHint() {
                    const hint = document.createElement('div');
                    hint.className = 'drag-select-hint';
                    hint.textContent = 'ÊãñÊãΩÈÄâÊã©Â§ö‰∏™Êù°ÁõÆ';
                    hint.id = 'drag-hint';
                    document.body.appendChild(hint);
                },

                // ÈöêËóèÊãñÊãΩÊèêÁ§∫
                hideDragHint() {
                    const hint = document.getElementById('drag-hint');
                    if (hint) {
                        hint.remove();
                    }
                },

                // ==================== Êú¨Âú∞Áä∂ÊÄÅÁÆ°ÁêÜ ====================

                // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅÂà∞localStorage
                saveCurrentState() {
                    try {
                        // ‰øùÂ≠òÈÖçÁΩÆ
                        localStorage.setItem(this.STORAGE_KEYS.CONFIG, JSON.stringify(this.config));
                        
                        // ‰øùÂ≠òÂ≠óÁ¨¶‰∏≤Êï∞ÊçÆÔºàÂè™‰øùÂ≠òÂøÖË¶ÅÁöÑ‰ø°ÊÅØÔºâ
                        if (this.strings.length > 0) {
                            const stringsData = this.strings.map(str => ({
                                text: str.text,
                                file_path: str.file_path,
                                line_number: str.line_number,
                                context: str.context,
                                resource_name: str.resource_name || '',
                                translation: str.translation || '',
                                selected: str.selected,
                                is_format_string: str.is_format_string || false,
                                format_params: str.format_params || [],
                                module_name: str.module_name || '',
                                unique_id: str.unique_id || `${str.file_path}:${str.line_number}`
                            }));
                            
                            // ÂàÜÊâπ‰øùÂ≠òÔºåÈÅøÂÖçlocalStorageÂÆπÈáèÈôêÂà∂
                            const batchSize = 50;
                            const totalBatches = Math.ceil(stringsData.length / batchSize);
                            
                            // Ê∏ÖÈô§ÊóßÁöÑÊâπÊ¨°Êï∞ÊçÆ
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            // ‰øùÂ≠òÊñ∞ÁöÑÊâπÊ¨°Êï∞ÊçÆ
                            for (let i = 0; i < totalBatches; i++) {
                                const start = i * batchSize;
                                const end = start + batchSize;
                                const batch = stringsData.slice(start, end);
                                localStorage.setItem(`${this.STORAGE_KEYS.STRINGS}_${i}`, JSON.stringify(batch));
                            }
                            
                            // ‰øùÂ≠òÂÖÉÊï∞ÊçÆ
                            localStorage.setItem(this.STORAGE_KEYS.STRINGS + '_meta', JSON.stringify({
                                totalBatches: totalBatches,
                                totalCount: stringsData.length,
                                timestamp: Date.now(),
                                currentStep: this.currentStep
                            }));
                        }
                        
                        console.log('Áä∂ÊÄÅ‰øùÂ≠òÊàêÂäü');
                    } catch (error) {
                        console.warn('‰øùÂ≠òÁä∂ÊÄÅÂ§±Ë¥•:', error);
                    }
                },

                // ‰ªélocalStorageÂä†ËΩΩ‰øùÂ≠òÁöÑÁä∂ÊÄÅ
                loadSavedState() {
                    try {
                        // ÊÅ¢Â§çÈÖçÁΩÆ
                        const savedConfig = localStorage.getItem(this.STORAGE_KEYS.CONFIG);
                        if (savedConfig) {
                            const config = JSON.parse(savedConfig);
                            // ‰øùÁïôÊïèÊÑü‰ø°ÊÅØÁöÑÂàùÂßãÂÄºÔºåÂè™ÊÅ¢Â§çÈùûÊïèÊÑüÈÖçÁΩÆ
                            this.config = {
                                ...this.config,
                                projectPath: config.projectPath || this.config.projectPath,
                                baseUrl: config.baseUrl || this.config.baseUrl,
                                modelName: config.modelName || this.config.modelName,
                                batchSize: config.batchSize || this.config.batchSize,
                                customPrompt: config.customPrompt || this.config.customPrompt,
                                referenceTranslations: config.referenceTranslations || this.config.referenceTranslations,
                                apiKey: config.apiKey || this.config.apiKey,
                                sourceXmlPath: config.sourceXmlPath || this.config.sourceXmlPath,
                                targetLanguage: config.targetLanguage || this.config.targetLanguage,
                                targetXmlPath: config.targetXmlPath || this.config.targetXmlPath
                            };
                        }

                        // ÊÅ¢Â§çÂ≠óÁ¨¶‰∏≤Êï∞ÊçÆ
                        const metaData = localStorage.getItem(this.STORAGE_KEYS.STRINGS + '_meta');
                        if (metaData) {
                            const meta = JSON.parse(metaData);
                            const age = Date.now() - meta.timestamp;
                            
                            // Â¶ÇÊûúÊï∞ÊçÆ‰∏çË∂ÖËøá10Â§©ÔºåÂàôÊÅ¢Â§ç
                            if (age < 10 * 24 * 60 * 60 * 1000) {
                                let allStrings = [];
                                
                                // Âä†ËΩΩÊâÄÊúâÊâπÊ¨°
                                for (let i = 0; i < meta.totalBatches; i++) {
                                    const batchData = localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                                    if (batchData) {
                                        const batch = JSON.parse(batchData);
                                        allStrings = allStrings.concat(batch);
                                    }
                                }
                                
                                if (allStrings.length > 0) {
                                    this.strings = allStrings;

                                    axios.post('/api/update_current_strings', {
                                        "strings": allStrings
                                    }).then(response => {
                                        console.log("update_current_strings response: ", response.data)
                                    });

                                    this.currentStep = meta.currentStep || 2;
                                    this.updateCounts();
                                    
                                    this.successMessage = `Â∑≤ÊÅ¢Â§ç ${allStrings.length} ‰∏™Â≠óÁ¨¶‰∏≤ÁöÑÁä∂ÊÄÅ`;
                                    setTimeout(() => {
                                        this.successMessage = '';
                                    }, 3000);
                                    
                                    console.log('Â≠óÁ¨¶‰∏≤Áä∂ÊÄÅÊÅ¢Â§çÊàêÂäü:', allStrings.length);
                                }
                            } else {
                                console.log('‰øùÂ≠òÁöÑÊï∞ÊçÆÂ∑≤ËøáÊúüÔºåË∑≥ËøáÊÅ¢Â§ç');
                                this.clearSavedState();
                            }
                        }
                    } catch (error) {
                        console.warn('Âä†ËΩΩÁä∂ÊÄÅÂ§±Ë¥•:', error);
                    }
                },



                // ÊâãÂä®‰øùÂ≠òÁä∂ÊÄÅÔºà‰æõÁî®Êà∑Ë∞ÉÁî®Ôºâ
                manualSave() {
                    this.saveCurrentState();
                    this.successMessage = 'Áä∂ÊÄÅ‰øùÂ≠òÊàêÂäüÔºÅ';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 2000);
                },

                // Ê∏ÖÈô§‰øùÂ≠òÁöÑÁä∂ÊÄÅÔºàÂ∏¶Á°ÆËÆ§Ôºâ
                clearSavedState() {
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ‰øùÂ≠òÁöÑÁä∂ÊÄÅÂêóÔºüËøôÂ∞ÜÂà†Èô§ÈÖçÁΩÆ„ÄÅÂ≠óÁ¨¶‰∏≤Êï∞ÊçÆÂíåÈÄâÊã©Áä∂ÊÄÅ„ÄÇ')) {
                        try {
                            // Ê∏ÖÈô§ÈÖçÁΩÆÂíåÂ≠óÁ¨¶‰∏≤Êï∞ÊçÆ
                            localStorage.removeItem(this.STORAGE_KEYS.CONFIG);
                            localStorage.removeItem(this.STORAGE_KEYS.STRINGS + '_meta');
                            
                            // Ê∏ÖÈô§ÊâÄÊúâÊâπÊ¨°Êï∞ÊçÆ
                            for (let i = 0; localStorage.getItem(`${this.STORAGE_KEYS.STRINGS}_${i}`); i++) {
                                localStorage.removeItem(`${this.STORAGE_KEYS.STRINGS}_${i}`);
                            }
                            
                            this.successMessage = 'Áä∂ÊÄÅÊ∏ÖÈô§ÂÆåÊàêÔºÅ';
                            setTimeout(() => {
                                this.successMessage = '';
                            }, 2000);
                            
                            console.log('Áä∂ÊÄÅÊ∏ÖÈô§ÂÆåÊàê');
                        } catch (error) {
                            this.error = 'Ê∏ÖÈô§Áä∂ÊÄÅÂ§±Ë¥•: ' + error.message;
                            console.warn('Ê∏ÖÈô§Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        }
                    }
                },

                // ==================== ËæÖÂä©ÊñπÊ≥ï ====================

                // ÁîüÊàêunique_id
                generateUniqueId(str) {
                    if (str.resource_name && str.module_name) {
                        return `${str.module_name}:${str.resource_name}`;
                    }
                    // Â¶ÇÊûúÊ≤°Êúâresource_nameÔºå‰ΩøÁî®Êñá‰ª∂Ë∑ØÂæÑÂíåË°åÂè∑
                    return `${str.file_path}:${str.line_number}`;
                },

                // Êõ¥Êñ∞Â≠óÁ¨¶‰∏≤ÁöÑunique_id
                updateUniqueId(str) {
                    const oldId = str.unique_id;
                    const newId = this.generateUniqueId(str);
                    
                    if (oldId !== newId) {
                        str.unique_id = newId;
                        
                        // Êõ¥Êñ∞Áõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅÊò†Â∞Ñ
                        if (this.lastSelectedStates.has(oldId)) {
                            const selected = this.lastSelectedStates.get(oldId);
                            this.lastSelectedStates.delete(oldId);
                            this.lastSelectedStates.set(newId, selected);
                        }
                    }
                },

                // ‰ªéÊñá‰ª∂Ë∑ØÂæÑÊèêÂèñÊ®°ÂùóÂêç
                extractModuleName(filePath) {
                    const parts = filePath.split('/');
                    return parts[0] || 'common';
                },

                // Ëá™Âä®ÊèêÂèñÂèÇËÄÉÁøªËØë
                async autoExtractReferences() {
                    if (!this.config.projectPath.trim()) {
                        this.error = 'ËØ∑ÂÖàËÆæÁΩÆÈ°πÁõÆË∑ØÂæÑ';
                        return;
                    }

                    this.extractingReferences = true;
                    this.error = '';

                    try {
                        const response = await axios.post('/api/extract_references', {
                            project_path: this.config.projectPath,
                            source_xml_path: this.config.sourceXmlPath,
                            target_language: this.config.targetLanguage,
                            target_xml_path: this.config.targetXmlPath,
                            limit: 10
                        });

                        if (response.data.success) {
                            const references = response.data.references;
                            if (references && references.length > 0) {
                                // Â∞ÜÊèêÂèñÁöÑÁøªËØëÂØπÁÖßÊ†ºÂºèÂåñ‰∏∫ÊñáÊú¨
                                const formattedReferences = references.map(ref => 
                                    `${ref.source} -> ${ref.target}`
                                ).join('\n');
                                
                                // Â¶ÇÊûúÂ∑≤ÊúâÂèÇËÄÉÁøªËØëÔºåÂàôËøΩÂä†ÔºåÂê¶ÂàôÁõ¥Êé•ËÆæÁΩÆ
                                if (this.config.referenceTranslations.trim()) {
                                    this.config.referenceTranslations += '\n' + formattedReferences;
                                } else {
                                    this.config.referenceTranslations = formattedReferences;
                                }
                                
                                this.successMessage = `ÊàêÂäüÊèêÂèñ‰∫Ü ${references.length} Êù°ÂèÇËÄÉÁøªËØë`;
                                setTimeout(() => {
                                    this.successMessage = '';
                                }, 3000);
                            } else {
                                this.error = 'Êú™ÊâæÂà∞ÂèØÁî®ÁöÑÁøªËØëÂØπÁÖßÔºåËØ∑Ê£ÄÊü•XMLÊñá‰ª∂Ë∑ØÂæÑÈÖçÁΩÆ';
                            }
                        } else {
                            this.error = response.data.error || 'ÊèêÂèñÂèÇËÄÉÁøªËØëÂ§±Ë¥•';
                        }
                    } catch (err) {
                        this.error = err.response?.data?.error || 'ÊèêÂèñÂèÇËÄÉÁøªËØëËØ∑Ê±ÇÂ§±Ë¥•';
                    } finally {
                        this.extractingReferences = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>